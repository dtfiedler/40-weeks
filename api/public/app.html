<!DOCTYPE html>
<html>
<head>
	<title>Your Pregnancy Journey - 40Weeks</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Track your pregnancy journey with 40Weeks">
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = {
			theme: {
				extend: {
					fontFamily: {
						'sans': ['Poppins', 'system-ui', 'sans-serif'],
						'serif': ['DM Serif Display', 'serif'],
					},
					colors: {
						primary: {
							50: '#fffbeb',
							100: '#fef3c7',
							200: '#fde68a',
							300: '#fcd34d',
							400: '#fbbf24',
							500: '#f59e0b',
							600: '#d97706',
							700: '#b45309',
							800: '#92400e',
							900: '#78350f'
						}
					}
				}
			}
		}
	</script>
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
	<style>
		/* Shadcn-inspired custom styles */
		:root {
			--background: 0 0% 100%;
			--foreground: 240 10% 3.9%;
			--card: 0 0% 100%;
			--card-foreground: 240 10% 3.9%;
			--primary: 240 5.9% 10%;
			--primary-foreground: 0 0% 98%;
			--secondary: 240 4.8% 95.9%;
			--secondary-foreground: 240 5.9% 10%;
			--muted: 240 4.8% 95.9%;
			--muted-foreground: 240 3.8% 46.1%;
			--destructive: 0 84.2% 60.2%;
			--destructive-foreground: 0 0% 98%;
			--border: 240 5.9% 90%;
			--input: 240 5.9% 90%;
			--ring: 240 10% 3.9%;
			--radius: 0.5rem;
		}

		body {
			font-family: 'Poppins', sans-serif;
			background-color: hsl(var(--background));
			color: hsl(var(--foreground));
		}

		.card {
			background-color: hsl(var(--card));
			color: hsl(var(--card-foreground));
			border-radius: var(--radius);
			border: 1px solid hsl(var(--border));
			box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
		}

		.btn-primary {
			background-color: hsl(var(--primary));
			color: hsl(var(--primary-foreground));
			border: 1px solid hsl(var(--primary));
			border-radius: calc(var(--radius) - 2px);
			padding: 0.75rem 1.5rem;
			font-size: 0.875rem;
			font-weight: 500;
			transition: all 0.2s;
		}

		.btn-primary:hover {
			background-color: hsl(var(--primary) / 0.9);
			transform: translateY(-1px);
			box-shadow: 0 4px 12px 0 rgb(0 0 0 / 0.15);
		}

		.btn-secondary {
			background-color: transparent;
			color: hsl(var(--foreground));
			border: 1px solid hsl(var(--border));
			border-radius: calc(var(--radius) - 2px);
			padding: 0.75rem 1.5rem;
			font-size: 0.875rem;
			font-weight: 500;
			transition: all 0.2s;
		}

		.btn-secondary:hover {
			background-color: hsl(var(--muted));
		}

		.hero-gradient {
			background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
		}
	</style>
</head>
<body class="bg-gray-50">
	<!-- Header -->
	<header class="bg-white border-b border-gray-200 sticky top-0 z-10">
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
			<div class="flex justify-between items-center h-16">
				<div class="flex items-center">
					<h1 class="text-xl font-semibold text-gray-900 font-serif">40Weeks</h1>
					<span class="ml-2 text-sm text-primary-500 font-medium">BETA</span>
				</div>
				<div class="flex items-center space-x-4">
					<button onclick="logout()" class="text-sm text-gray-500 hover:text-gray-700">
						Sign out
					</button>
				</div>
			</div>
		</div>
	</header>

	<!-- Main Content -->
	<main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
		<!-- Welcome Section -->
		<div class="mb-8">
			<div class="hero-gradient rounded-lg p-6 text-white">
				<div class="flex items-center justify-between">
					<div>
						<h1 class="text-2xl font-bold font-serif mb-2">Welcome back!</h1>
						<p class="text-yellow-100" id="pregnancyGreeting">Loading your pregnancy details...</p>
					</div>
					<div class="text-right">
						<div class="text-3xl font-bold" id="currentWeek">--</div>
						<div class="text-yellow-100 text-sm">weeks</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Quick Actions -->
		<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
			<div class="card p-6 text-center hover:shadow-lg transition-shadow cursor-pointer" onclick="addToVillage()">
				<div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mx-auto mb-4">
					<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
					</svg>
				</div>
				<h3 class="text-lg font-semibold text-gray-900 mb-2">Your Village</h3>
				<p class="text-gray-600 text-sm mb-2" id="villageCountText">Loading village...</p>
				<p class="text-gray-500 text-xs">Manage your followers</p>
			</div>

			<div class="card p-6 text-center hover:shadow-lg transition-shadow cursor-pointer" onclick="postUpdate()">
				<div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mx-auto mb-4">
					<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
					</svg>
				</div>
				<h3 class="text-lg font-semibold text-gray-900 mb-2">Post an Update</h3>
				<p class="text-gray-600 text-sm">Share photos and news with your village</p>
			</div>

			<div class="card p-6 text-center hover:shadow-lg transition-shadow cursor-pointer" onclick="viewMilestones()">
				<div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mx-auto mb-4">
					<svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
					</svg>
				</div>
				<h3 class="text-lg font-semibold text-gray-900 mb-2">View Milestones</h3>
				<p class="text-gray-600 text-sm">Track upcoming appointments and events</p>
			</div>
		</div>

		<!-- Pregnancy Overview -->
		<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
			<!-- Pregnancy Details -->
			<div class="lg:col-span-2">
				<div class="card p-6">
					<h2 class="text-xl font-semibold text-gray-900 mb-4 font-serif">Your Pregnancy Details</h2>
					<div class="space-y-4" id="pregnancyDetails">
						<div class="flex justify-between items-center py-2 border-b border-gray-100">
							<span class="text-gray-600">Due Date</span>
							<span class="font-medium" id="dueDate">Loading...</span>
						</div>
						<div class="flex justify-between items-center py-2 border-b border-gray-100">
							<span class="text-gray-600">Baby's Name</span>
							<span class="font-medium" id="babyName">Loading...</span>
						</div>
						<div class="flex justify-between items-center py-2 border-b border-gray-100">
							<span class="text-gray-600">Partner</span>
							<span class="font-medium" id="partnerName">Loading...</span>
						</div>
						<div class="flex justify-between items-center py-2">
							<span class="text-gray-600">Weeks Remaining</span>
							<span class="font-medium" id="weeksRemaining">Loading...</span>
						</div>
					</div>
					<div class="mt-6">
						<button onclick="editPregnancyDetails()" class="btn-secondary">Edit Details</button>
					</div>
				</div>
			</div>

			<!-- Upcoming Milestones -->
			<div>
				<div class="card p-6">
					<h2 class="text-xl font-semibold text-gray-900 mb-4 font-serif">Upcoming Milestones</h2>
					<div class="space-y-3" id="upcomingMilestones">
						<div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
							<div class="text-sm font-medium text-blue-800">Loading milestones...</div>
						</div>
					</div>
					<div class="mt-4">
						<button class="btn-secondary w-full" onclick="viewMilestones()">View All Milestones</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Pregnancy Timeline -->
		<div class="mt-8">
			<div class="card p-6">
				<div class="flex items-center justify-between mb-6">
					<h2 class="text-xl font-semibold text-gray-900 font-serif">Your Pregnancy Timeline</h2>
					<button id="loadMoreEvents" class="btn-secondary text-sm" style="display: none;">
						Load More
					</button>
				</div>
				
				<div id="timelineContainer" class="space-y-4">
					<div class="text-center py-8">
						<div class="text-gray-500">Loading your pregnancy journey...</div>
					</div>
				</div>
			</div>
		</div>
	</main>

	<script>
		const token = localStorage.getItem('jwt_token');
		
		if (!token) {
			window.location.href = '/login';
		}

		// Load pregnancy data on page load
		async function loadPregnancyData() {
			try {
				const response = await fetch('/api/pregnancy/current', {
					headers: {
						'Authorization': 'Bearer ' + token
					}
				});
				
				if (response.ok) {
					const data = await response.json();
					displayPregnancyData(data);
					loadVillageData(); // Load village data after pregnancy data loads
				} else if (response.status === 404) {
					// User doesn't have pregnancy setup, redirect to setup
					window.location.href = '/pregnancy-setup';
				} else {
					showError('Failed to load pregnancy data');
				}
			} catch (err) {
				showError('Network error loading pregnancy data');
			}
		}

		// Load village member count
		async function loadVillageData() {
			try {
				const response = await fetch('/api/village-members', {
					headers: {
						'Authorization': 'Bearer ' + token
					}
				});
				
				if (response.ok) {
					const members = await response.json();
					// Ensure members is always an array, handle null/undefined
					const safeMembers = Array.isArray(members) ? members : [];
					displayVillageCount(safeMembers);
				} else {
					// If 404, no village members yet
					displayVillageCount([]);
				}
			} catch (err) {
				console.error('Error loading village data:', err);
				displayVillageCount([]);
			}
		}

		function calculateVillageCount(members) {
			let totalCount = 0;
			
			// Count each member based on relationship type
			// Parents, friends, and in-laws count as 2 people
			const doubleCountRelationships = [
				'parents',        // Parents (both)
				'in-laws',        // In-laws (both)  
				'friends',        // Friends
				'siblings'        // Siblings
			];
			
			// Individual relationships that count as 2 (representing couples)
			const coupleRelationships = [
				'mother',         // Mother (represents both parents if father not separately added)
				'father',         // Father (represents both parents if mother not separately added)
				'mother-in-law',  // Mother-in-law (represents both in-laws if father-in-law not separately added)
				'father-in-law',  // Father-in-law (represents both in-laws if mother-in-law not separately added)
				'friend'          // Friend (could represent a couple)
			];
			
			members.forEach(member => {
				const relationship = member.relationship;
				
				// Check if this relationship should count as 2
				if (doubleCountRelationships.includes(relationship) || 
				    coupleRelationships.includes(relationship)) {
					totalCount += 2;
				} else {
					totalCount += 1;
				}
			});
			
			return totalCount;
		}

		function displayVillageCount(members) {
			// Handle case where members might be a number (legacy), array, null, or undefined
			let count = 0;
			if (Array.isArray(members)) {
				count = calculateVillageCount(members);
			} else if (typeof members === 'number') {
				count = members;
			} else {
				// Handle null, undefined, or other types
				count = 0;
			}

			const villageCountEl = document.getElementById('villageCountText');
			
			if (count === 0) {
				villageCountEl.textContent = 'Build your village!';
			} else if (count === 1) {
				villageCountEl.textContent = '1 person following';
			} else {
				villageCountEl.textContent = `${count} people following`;
			}
		}

		function displayPregnancyData(pregnancy) {
			// Update greeting
			const greeting = document.getElementById('pregnancyGreeting');
			const babyName = pregnancy.baby_name || 'Baby';
			greeting.textContent = `You're expecting ${babyName}!`;

			// Update current week
			const currentWeekEl = document.getElementById('currentWeek');
			currentWeekEl.textContent = pregnancy.current_week_calculated || '--';

			// Update pregnancy details
			const dueDate = new Date(pregnancy.due_date).toLocaleDateString();
			document.getElementById('dueDate').textContent = dueDate;
			document.getElementById('babyName').textContent = pregnancy.baby_name || 'Baby';
			document.getElementById('partnerName').textContent = pregnancy.partner_name || 'Not specified';
			
			// Calculate weeks remaining
			const today = new Date();
			const due = new Date(pregnancy.due_date);
			const diffTime = due - today;
			const weeksRemaining = Math.ceil(diffTime / (1000 * 60 * 60 * 24 * 7));
			document.getElementById('weeksRemaining').textContent = weeksRemaining > 0 ? `${weeksRemaining} weeks` : 'Due any day!';
		}

		function showError(message) {
			console.error(message);
			// Could add a toast notification here
		}

		// Action handlers
		function addToVillage() {
			window.location.href = '/manage/village';
		}

		function postUpdate() {
			// TODO: Implement update posting
			alert('Update posting coming soon!');
		}

		function viewMilestones() {
			// TODO: Implement milestone view
			alert('Milestone tracking coming soon!');
		}

		function editPregnancyDetails() {
			window.location.href = '/manage/pregnancy';
		}

		function logout() {
			localStorage.removeItem('jwt_token');
			window.location.href = '/login';
		}

		// Timeline functionality
		let timelineOffset = 0;
		const timelineLimit = 10;

		// Load timeline events
		async function loadTimelineEvents(offset = 0, append = false) {
			try {
				const response = await fetch(`/api/timeline?limit=${timelineLimit}&offset=${offset}`, {
					headers: {
						'Authorization': 'Bearer ' + token
					}
				});
				
				if (response.ok) {
					const data = await response.json();
					displayTimelineEvents(data.events, append);
					
					// Show/hide load more button
					const loadMoreBtn = document.getElementById('loadMoreEvents');
					if (data.events.length === timelineLimit) {
						loadMoreBtn.style.display = 'block';
						timelineOffset = offset + timelineLimit;
					} else {
						loadMoreBtn.style.display = 'none';
					}
				} else {
					displayTimelineEvents([], append);
				}
			} catch (err) {
				console.error('Failed to load timeline events:', err);
				displayTimelineEvents([], append);
			}
		}

		// Display timeline events
		function displayTimelineEvents(events, append = false) {
			const container = document.getElementById('timelineContainer');
			
			if (!append) {
				container.innerHTML = '';
			}

			if (events.length === 0 && !append) {
				container.innerHTML = `
					<div class="text-center py-8">
						<div class="text-gray-500">Your pregnancy journey will appear here as you reach milestones and your village grows!</div>
					</div>
				`;
				return;
			}

			events.forEach(event => {
				const eventElement = createTimelineEventElement(event);
				container.appendChild(eventElement);
			});
		}

		// Create timeline event element
		function createTimelineEventElement(event) {
			const div = document.createElement('div');
			div.className = 'flex items-start space-x-4 p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors';
			
			const icon = getEventIcon(event.event_type);
			const color = getEventColor(event.event_type);
			const timeAgo = getTimeAgo(event.created_at);
			
			div.innerHTML = `
				<div class="flex-shrink-0">
					<div class="w-10 h-10 ${color} bg-opacity-10 rounded-full flex items-center justify-center">
						<span class="text-lg">${icon}</span>
					</div>
				</div>
				<div class="flex-1 min-w-0">
					<div class="flex items-center justify-between">
						<h3 class="text-sm font-medium text-gray-900">${event.event_title}</h3>
						<div class="flex items-center space-x-2 text-xs text-gray-500">
							${event.week_number ? `<span class="bg-gray-100 px-2 py-1 rounded">Week ${event.week_number}</span>` : ''}
							<span>${timeAgo}</span>
						</div>
					</div>
					${event.event_description ? `<p class="text-sm text-gray-600 mt-1">${event.event_description}</p>` : ''}
				</div>
			`;
			
			return div;
		}

		// Get event icon based on type
		function getEventIcon(eventType) {
			const icons = {
				'pregnancy_announced': 'üéâ',
				'villager_joined': 'üë•',
				'villager_told': 'üíå',
				'milestone_reached': 'üèÜ',
				'appointment_completed': 'üè•',
				'update_posted': 'üìù',
				'week_progression': 'üìÖ'
			};
			return icons[eventType] || 'üìå';
		}

		// Get event color based on type
		function getEventColor(eventType) {
			const colors = {
				'pregnancy_announced': 'text-pink-600',
				'villager_joined': 'text-blue-600',
				'villager_told': 'text-purple-600',
				'milestone_reached': 'text-yellow-600',
				'appointment_completed': 'text-green-600',
				'update_posted': 'text-indigo-600',
				'week_progression': 'text-gray-600'
			};
			return colors[eventType] || 'text-gray-500';
		}

		// Get time ago string
		function getTimeAgo(dateString) {
			const date = new Date(dateString);
			const now = new Date();
			const diffTime = Math.abs(now - date);
			const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
			
			if (diffDays === 0) {
				const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
				if (diffHours === 0) {
					const diffMinutes = Math.floor(diffTime / (1000 * 60));
					return diffMinutes <= 1 ? 'Just now' : `${diffMinutes} minutes ago`;
				}
				return diffHours === 1 ? '1 hour ago' : `${diffHours} hours ago`;
			} else if (diffDays === 1) {
				return 'Yesterday';
			} else if (diffDays < 7) {
				return `${diffDays} days ago`;
			} else if (diffDays < 30) {
				const weeks = Math.floor(diffDays / 7);
				return weeks === 1 ? '1 week ago' : `${weeks} weeks ago`;
			} else {
				return date.toLocaleDateString();
			}
		}

		// Load more events button
		document.getElementById('loadMoreEvents').addEventListener('click', function() {
			loadTimelineEvents(timelineOffset, true);
		});

		// Load data when page loads
		loadPregnancyData();
		loadTimelineEvents();
	</script>
</body>
</html>