<!DOCTYPE html>
<html>
<head>
	<title>Your Pregnancy Journey - 40Weeks</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Track your pregnancy journey with 40Weeks">
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = {
			theme: {
				extend: {
					fontFamily: {
						'sans': ['Poppins', 'system-ui', 'sans-serif'],
						'serif': ['DM Serif Display', 'serif'],
					},
					colors: {
						primary: {
							50: '#fffbeb',
							100: '#fef3c7',
							200: '#fde68a',
							300: '#fcd34d',
							400: '#fbbf24',
							500: '#f59e0b',
							600: '#d97706',
							700: '#b45309',
							800: '#92400e',
							900: '#78350f'
						}
					}
				}
			}
		}
	</script>
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
	<style>
		/* Shadcn-inspired custom styles */
		:root {
			--background: 0 0% 100%;
			--foreground: 240 10% 3.9%;
			--card: 0 0% 100%;
			--card-foreground: 240 10% 3.9%;
			--primary: 240 5.9% 10%;
			--primary-foreground: 0 0% 98%;
			--secondary: 240 4.8% 95.9%;
			--secondary-foreground: 240 5.9% 10%;
			--muted: 240 4.8% 95.9%;
			--muted-foreground: 240 3.8% 46.1%;
			--destructive: 0 84.2% 60.2%;
			--destructive-foreground: 0 0% 98%;
			--border: 240 5.9% 90%;
			--input: 240 5.9% 90%;
			--ring: 240 10% 3.9%;
			--radius: 0.5rem;
		}

		body {
			font-family: 'Poppins', sans-serif;
			background-color: hsl(var(--background));
			color: hsl(var(--foreground));
		}

		.card {
			background-color: hsl(var(--card));
			color: hsl(var(--card-foreground));
			border-radius: var(--radius);
			border: 1px solid hsl(var(--border));
			box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
		}

		.btn-primary {
			background-color: hsl(var(--primary));
			color: hsl(var(--primary-foreground));
			border: 1px solid hsl(var(--primary));
			border-radius: calc(var(--radius) - 2px);
			padding: 0.75rem 1.5rem;
			font-size: 0.875rem;
			font-weight: 500;
			transition: all 0.2s;
		}

		.btn-primary:hover {
			background-color: hsl(var(--primary) / 0.9);
			transform: translateY(-1px);
			box-shadow: 0 4px 12px 0 rgb(0 0 0 / 0.15);
		}

		.btn-secondary {
			background-color: transparent;
			color: hsl(var(--foreground));
			border: 1px solid hsl(var(--border));
			border-radius: calc(var(--radius) - 2px);
			padding: 0.75rem 1.5rem;
			font-size: 0.875rem;
			font-weight: 500;
			transition: all 0.2s;
		}

		.btn-secondary:hover {
			background-color: hsl(var(--muted));
		}

		.hero-gradient {
			background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
		}
	</style>
</head>
<body class="bg-gray-50">
	<!-- Header -->
	<header class="bg-white border-b border-gray-200 sticky top-0 z-10">
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
			<div class="flex justify-between items-center h-16">
				<div class="flex items-center">
					<h1 class="text-xl font-semibold text-gray-900 font-serif">40Weeks</h1>
					<span class="ml-2 text-sm text-primary-500 font-medium">BETA</span>
				</div>
				<div class="flex items-center space-x-4">
					<button onclick="logout()" class="text-sm text-gray-500 hover:text-gray-700">
						Sign out
					</button>
				</div>
			</div>
		</div>
	</header>

	<!-- Main Content -->
	<main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
		<!-- Welcome Section -->
		<div class="mb-8">
			<div class="hero-gradient rounded-lg p-6 text-white relative overflow-hidden">
				<!-- Cover Photo Background -->
				<div id="coverPhotoBackground" class="absolute inset-0 opacity-30 bg-black hidden">
					<img id="coverPhotoImage" src="" alt="Cover photo" class="w-full h-full object-cover">
				</div>
				
				<!-- Content -->
				<div class="relative z-10 flex items-center justify-between">
					<div class="flex-1">
						<div class="flex items-center justify-between">
							<div>
								<h1 class="text-2xl font-bold font-serif mb-2">Welcome back!</h1>
								<p class="text-yellow-100" id="pregnancyGreeting">Loading your pregnancy details...</p>
							</div>
							<div class="text-right">
								<div class="text-3xl font-bold" id="currentWeek">--</div>
								<div class="text-yellow-100 text-sm">weeks</div>
							</div>
						</div>
					</div>
				</div>
				
				<!-- Cover Photo Edit Button -->
				<button id="editCoverPhotoBtn" onclick="showCoverPhotoModal()" 
					class="absolute top-4 right-4 bg-black bg-opacity-70 hover:bg-opacity-90 text-white p-3 rounded-lg transition-all duration-200 shadow-lg z-20">
					<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
					</svg>
				</button>
			</div>
		</div>

		<!-- Quick Actions -->
		<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
			<div class="card p-6 text-center hover:shadow-lg transition-shadow cursor-pointer" onclick="addToVillage()">
				<div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mx-auto mb-4">
					<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
					</svg>
				</div>
				<h3 class="text-lg font-semibold text-gray-900 mb-2">Your Village</h3>
				<p class="text-gray-600 text-sm mb-2" id="villageCountText">Loading village...</p>
				<p class="text-gray-500 text-xs">Manage your followers</p>
			</div>

			<div class="card p-6 text-center hover:shadow-lg transition-shadow cursor-pointer" onclick="postUpdate()">
				<div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mx-auto mb-4">
					<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
					</svg>
				</div>
				<h3 class="text-lg font-semibold text-gray-900 mb-2">Post an Update</h3>
				<p class="text-gray-600 text-sm">Share photos and news with your village</p>
			</div>

			<div class="card p-6 text-center hover:shadow-lg transition-shadow cursor-pointer" onclick="viewTimeline()">
				<div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mx-auto mb-4">
					<svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
					</svg>
				</div>
				<h3 class="text-lg font-semibold text-gray-900 mb-2">View Timeline</h3>
				<p class="text-gray-600 text-sm">See your shared updates and photos</p>
			</div>

			<div class="card p-6 text-center hover:shadow-lg transition-shadow cursor-pointer" onclick="shareTimeline()">
				<div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center mx-auto mb-4">
					<svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
					</svg>
				</div>
				<h3 class="text-lg font-semibold text-gray-900 mb-2">Share Timeline</h3>
				<p class="text-gray-600 text-sm">Copy link to share your journey</p>
			</div>
		</div>

		<!-- Pregnancy Overview -->
		<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
			<!-- Pregnancy Details -->
			<div class="lg:col-span-2">
				<div class="card p-6">
					<h2 class="text-xl font-semibold text-gray-900 mb-4 font-serif">Your Pregnancy Details</h2>
					<div class="space-y-4" id="pregnancyDetails">
						<div class="flex justify-between items-center py-2 border-b border-gray-100">
							<span class="text-gray-600">Due Date</span>
							<span class="font-medium" id="dueDate">Loading...</span>
						</div>
						<div class="flex justify-between items-center py-2 border-b border-gray-100">
							<span class="text-gray-600">Baby's Name</span>
							<span class="font-medium" id="babyName">Loading...</span>
						</div>
						<div class="flex justify-between items-center py-2 border-b border-gray-100">
							<span class="text-gray-600">Partner</span>
							<span class="font-medium" id="partnerName">Loading...</span>
						</div>
						<div class="flex justify-between items-center py-2">
							<span class="text-gray-600">Weeks Remaining</span>
							<span class="font-medium" id="weeksRemaining">Loading...</span>
						</div>
					</div>
					<div class="mt-6">
						<button onclick="editPregnancyDetails()" class="btn-secondary">Edit Details</button>
					</div>
				</div>
			</div>

			<!-- Upcoming Milestones -->
			<div>
				<div class="card p-6">
					<h2 class="text-xl font-semibold text-gray-900 mb-4 font-serif">Upcoming Milestones</h2>
					<div class="space-y-3" id="upcomingMilestones">
						<div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
							<div class="text-sm font-medium text-blue-800">Loading milestones...</div>
						</div>
					</div>
					<div class="mt-4">
						<button class="btn-secondary w-full" onclick="viewMilestones()">View All Milestones</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Pregnancy Timeline -->
		<div class="mt-8">
			<div class="card p-6">
				<div class="mb-6">
					<h2 class="text-xl font-semibold text-gray-900 font-serif">Your Pregnancy Timeline</h2>
				</div>
				
				<div id="timelineContainer" class="space-y-4">
					<div class="text-center py-8">
						<div class="text-gray-500">Loading your pregnancy journey...</div>
					</div>
				</div>
				
				<!-- Load More Button - centered at bottom -->
				<div class="flex justify-center mt-6">
					<button id="loadMoreEvents" class="btn-secondary" style="display: none;">
						Load More
					</button>
				</div>
			</div>
		</div>
	</main>

	<script>
		const token = localStorage.getItem('jwt_token');
		
		if (!token) {
			window.location.href = '/login';
		}

		// Load pregnancy data on page load
		async function loadPregnancyData() {
			try {
				const response = await fetch('/api/pregnancy/current', {
					headers: {
						'Authorization': 'Bearer ' + token
					}
				});
				
				if (response.ok) {
					const data = await response.json();
					displayPregnancyData(data);
					loadVillageData(); // Load village data after pregnancy data loads
				} else if (response.status === 404) {
					// User doesn't have pregnancy setup, redirect to setup
					window.location.href = '/pregnancy-setup';
				} else {
					showError('Failed to load pregnancy data');
				}
			} catch (err) {
				showError('Network error loading pregnancy data');
			}
		}

		// Load village member count
		async function loadVillageData() {
			try {
				const response = await fetch('/api/village-members', {
					headers: {
						'Authorization': 'Bearer ' + token
					}
				});
				
				if (response.ok) {
					const members = await response.json();
					// Ensure members is always an array, handle null/undefined
					const safeMembers = Array.isArray(members) ? members : [];
					displayVillageCount(safeMembers);
				} else {
					// If 404, no village members yet
					displayVillageCount([]);
				}
			} catch (err) {
				console.error('Error loading village data:', err);
				displayVillageCount([]);
			}
		}

		function calculateVillageCount(members) {
			let totalCount = 0;
			
			// Count each member based on relationship type
			// Parents, friends, and in-laws count as 2 people
			const doubleCountRelationships = [
				'parents',        // Parents (both)
				'in-laws',        // In-laws (both)  
				'friends',        // Friends
				'siblings'        // Siblings
			];
			
			// Individual relationships that count as 2 (representing couples)
			const coupleRelationships = [
				'mother',         // Mother (represents both parents if father not separately added)
				'father',         // Father (represents both parents if mother not separately added)
				'mother-in-law',  // Mother-in-law (represents both in-laws if father-in-law not separately added)
				'father-in-law',  // Father-in-law (represents both in-laws if mother-in-law not separately added)
				'friend'          // Friend (could represent a couple)
			];
			
			members.forEach(member => {
				const relationship = member.relationship;
				
				// Check if this relationship should count as 2
				if (doubleCountRelationships.includes(relationship) || 
				    coupleRelationships.includes(relationship)) {
					totalCount += 2;
				} else {
					totalCount += 1;
				}
			});
			
			return totalCount;
		}

		function displayVillageCount(members) {
			// Handle case where members might be a number (legacy), array, null, or undefined
			let count = 0;
			if (Array.isArray(members)) {
				count = calculateVillageCount(members);
			} else if (typeof members === 'number') {
				count = members;
			} else {
				// Handle null, undefined, or other types
				count = 0;
			}

			const villageCountEl = document.getElementById('villageCountText');
			
			if (count === 0) {
				villageCountEl.textContent = 'Build your village!';
			} else if (count === 1) {
				villageCountEl.textContent = '1 person following';
			} else {
				villageCountEl.textContent = `${count} people following`;
			}
		}

		function displayPregnancyData(pregnancy) {
			// Update greeting
			const greeting = document.getElementById('pregnancyGreeting');
			const babyName = pregnancy.baby_name || 'Baby';
			greeting.textContent = `You're expecting ${babyName}!`;

			// Update current week
			const currentWeekEl = document.getElementById('currentWeek');
			currentWeekEl.textContent = pregnancy.current_week_calculated || '--';

			// Update cover photo in welcome section
			updateWelcomeCoverPhoto(pregnancy);

			// Update pregnancy details
			const dueDate = new Date(pregnancy.due_date).toLocaleDateString();
			document.getElementById('dueDate').textContent = dueDate;
			document.getElementById('babyName').textContent = pregnancy.baby_name || 'Baby';
			document.getElementById('partnerName').textContent = pregnancy.partner_name || 'Not specified';
			
			// Calculate weeks remaining
			const today = new Date();
			const due = new Date(pregnancy.due_date);
			const diffTime = due - today;
			const weeksRemaining = Math.ceil(diffTime / (1000 * 60 * 60 * 24 * 7));
			document.getElementById('weeksRemaining').textContent = weeksRemaining > 0 ? `${weeksRemaining} weeks` : 'Due any day!';
		}

		function updateWelcomeCoverPhoto(pregnancy) {
			const coverPhotoBackground = document.getElementById('coverPhotoBackground');
			const coverPhotoImage = document.getElementById('coverPhotoImage');
			const editButton = document.getElementById('editCoverPhotoBtn');
			
			if (pregnancy.cover_photo_filename) {
				// Show cover photo
				coverPhotoImage.src = `/images/covers/${pregnancy.cover_photo_filename}`;
				coverPhotoBackground.classList.remove('hidden');
			} else {
				// Hide cover photo
				coverPhotoBackground.classList.add('hidden');
			}
			
			// Button should always be visible for both adding and editing
			editButton.style.display = 'block';
		}

		function showError(message) {
			console.error(message);
			// Could add a toast notification here
		}

		// Action handlers
		function addToVillage() {
			window.location.href = '/manage/village';
		}

		function postUpdate() {
			showUpdateModal();
		}

		function viewMilestones() {
			// TODO: Implement milestone view
			alert('Milestone tracking coming soon!');
		}

		async function viewTimeline() {
			try {
				const response = await fetch('/api/pregnancy/invite-hash', {
					headers: {
						'Authorization': 'Bearer ' + token
					}
				});
				
				if (response.ok) {
					const data = await response.json();
					const timelineLink = `${window.location.origin}/view/${data.hash}`;
					window.open(timelineLink, '_blank');
				} else {
					showError('Failed to get timeline link');
				}
			} catch (err) {
				showError('Network error. Please try again.');
			}
		}

		async function shareTimeline() {
			try {
				const response = await fetch('/api/pregnancy/invite-hash', {
					headers: {
						'Authorization': 'Bearer ' + token
					}
				});
				
				if (response.ok) {
					const data = await response.json();
					const timelineLink = `${window.location.origin}/view/${data.hash}`;
					
					if (navigator.clipboard) {
						await navigator.clipboard.writeText(timelineLink);
						showSuccess('Timeline link copied to clipboard!');
					} else {
						// Fallback for older browsers
						const textArea = document.createElement('textarea');
						textArea.value = timelineLink;
						document.body.appendChild(textArea);
						textArea.select();
						document.execCommand('copy');
						document.body.removeChild(textArea);
						showSuccess('Timeline link copied to clipboard!');
					}
				} else {
					showError('Failed to get timeline link');
				}
			} catch (err) {
				showError('Network error. Please try again.');
			}
		}

		function editPregnancyDetails() {
			window.location.href = '/manage/pregnancy';
		}

		function logout() {
			localStorage.removeItem('jwt_token');
			window.location.href = '/login';
		}

		// Timeline functionality
		let timelineOffset = 0;
		const timelineLimit = 10;

		// Load timeline events
		async function loadTimelineEvents(offset = 0, append = false) {
			try {
				const response = await fetch(`/api/timeline?limit=${timelineLimit}&offset=${offset}`, {
					headers: {
						'Authorization': 'Bearer ' + token
					}
				});
				
				if (response.ok) {
					const data = await response.json();
					displayTimelineEvents(data.events, append);
					
					// Show/hide load more button
					const loadMoreBtn = document.getElementById('loadMoreEvents');
					if (data.events && data.events.length === timelineLimit) {
						loadMoreBtn.style.display = 'block';
						timelineOffset = offset + timelineLimit;
					} else {
						loadMoreBtn.style.display = 'none';
					}
				} else {
					displayTimelineEvents([], append);
				}
			} catch (err) {
				console.error('Failed to load timeline events:', err);
				displayTimelineEvents([], append);
			}
		}

		// Display timeline events
		function displayTimelineEvents(events, append = false) {
			const container = document.getElementById('timelineContainer');
			
			if (!append) {
				container.innerHTML = '';
			}

			if (events.length === 0 && !append) {
				container.innerHTML = `
					<div class="text-center py-8">
						<div class="text-gray-500">Your pregnancy journey will appear here as you reach milestones and your village grows!</div>
					</div>
				`;
				return;
			}

			events.forEach(event => {
				const eventElement = createTimelineEventElement(event);
				container.appendChild(eventElement);
			});
		}

		// Create timeline event element
		function createTimelineEventElement(event) {
			const div = document.createElement('div');
			div.className = 'border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors';
			
			const icon = getEventIcon(event.type === 'event' ? event.event_type : 'update_posted');
			const color = getEventColor(event.type === 'event' ? event.event_type : 'update_posted');
			const timeAgo = getTimeAgo(event.created_at);
			const title = event.title;
			
			let mediaHtml = '';
			if (event.type === 'update' && event.photos && event.photos.length > 0) {
				// Separate photos and videos
				const photos = event.photos.filter(item => {
					const ext = item.filename.toLowerCase().split('.').pop();
					return ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext);
				});
				const videos = event.photos.filter(item => {
					const ext = item.filename.toLowerCase().split('.').pop();
					return ['mp4', 'mov'].includes(ext);
				});

				const allMedia = [...photos, ...videos];
				
				mediaHtml = `
					<div class="mt-3">
						<div class="grid grid-cols-2 md:grid-cols-3 gap-2">
							${allMedia.slice(0, 6).map(media => {
								const ext = media.filename.toLowerCase().split('.').pop();
								const isVideo = ['mp4', 'mov'].includes(ext);
								const path = isVideo ? 'videos' : 'images';
								
								if (isVideo) {
									return `
										<div class="aspect-square bg-gray-100 rounded-lg overflow-hidden cursor-pointer relative" 
											 onclick="openVideoModal('/videos/${event.pregnancy_id}/${media.filename}', '${media.original_filename}')">
											<video class="w-full h-full object-cover" preload="metadata">
												<source src="/videos/${event.pregnancy_id}/${media.filename}#t=0.5" type="video/${ext === 'mov' ? 'quicktime' : 'mp4'}">
											</video>
											<div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-30">
												<div class="w-8 h-8 bg-white bg-opacity-90 rounded-full flex items-center justify-center">
													<svg class="w-4 h-4 text-gray-800" fill="currentColor" viewBox="0 0 20 20">
														<path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/>
													</svg>
												</div>
											</div>
										</div>
									`;
								} else {
									return `
										<div class="aspect-square bg-gray-100 rounded-lg overflow-hidden cursor-pointer" 
											 onclick="openPhotoModal('/images/${event.pregnancy_id}/${media.filename}', '${media.original_filename}')">
											<img src="/images/${event.pregnancy_id}/${media.filename}" 
												 alt="${media.original_filename}"
												 class="w-full h-full object-cover"
												 loading="lazy"
												 onerror="this.parentElement.innerHTML='<div class=\\'w-full h-full bg-gray-200 flex items-center justify-center\\'>üì∑</div>'">
										</div>
									`;
								}
							}).join('')}
							${allMedia.length > 6 ? `
								<div class="aspect-square bg-gray-100 rounded-lg flex items-center justify-center text-gray-500">
									+${allMedia.length - 6} more
								</div>
							` : ''}
						</div>
					</div>
				`;
			}
			
			div.innerHTML = `
				<div class="p-4">
					<div class="flex items-start space-x-4">
						<div class="flex-shrink-0">
							<div class="w-10 h-10 ${color} bg-opacity-10 rounded-full flex items-center justify-center">
								<span class="text-lg">${icon}</span>
							</div>
						</div>
						<div class="flex-1 min-w-0">
							<div class="flex items-center justify-between">
								<div class="flex-1">
									<h3 class="text-sm font-medium text-gray-900">${title}</h3>
									${event.type === 'update' && event.created_by ? `<p class="text-xs text-gray-500 mt-1">Posted by ${event.created_by.split(' ')[0]}</p>` : ''}
								</div>
								<div class="flex items-center space-x-2 text-xs text-gray-500">
									${event.week_number ? `<span class="bg-gray-100 px-2 py-1 rounded">Week ${event.week_number}</span>` : ''}
									<span>${timeAgo}</span>
									${event.type === 'update' ? `
										<button onclick="editUpdate(${event.id})" class="text-blue-600 hover:text-blue-800 ml-2 p-1 hover:bg-blue-50 rounded">
											<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
											</svg>
										</button>
									` : ''}
								</div>
							</div>
							${event.description ? `<p class="text-sm text-gray-600 mt-1">${event.description}</p>` : ''}
							${mediaHtml}
						</div>
					</div>
				</div>
			`;
			
			return div;
		}

		// Get event icon based on type
		function getEventIcon(eventType) {
			const icons = {
				'pregnancy_announced': 'üéâ',
				'villager_joined': 'üë•',
				'villager_told': 'üíå',
				'milestone_reached': 'üèÜ',
				'appointment_completed': 'üè•',
				'update_posted': 'üì∏',
				'week_progression': 'üìÖ'
			};
			return icons[eventType] || 'üìå';
		}

		// Get event color based on type
		function getEventColor(eventType) {
			const colors = {
				'pregnancy_announced': 'text-pink-600',
				'villager_joined': 'text-blue-600',
				'villager_told': 'text-purple-600',
				'milestone_reached': 'text-yellow-600',
				'appointment_completed': 'text-green-600',
				'update_posted': 'text-purple-600',
				'week_progression': 'text-gray-600'
			};
			return colors[eventType] || 'text-gray-500';
		}

		// Get time ago string
		function getTimeAgo(dateString) {
			const date = new Date(dateString);
			const now = new Date();
			const diffTime = Math.abs(now - date);
			const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
			
			if (diffDays === 0) {
				const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
				if (diffHours === 0) {
					const diffMinutes = Math.floor(diffTime / (1000 * 60));
					return diffMinutes <= 1 ? 'Just now' : `${diffMinutes} minutes ago`;
				}
				return diffHours === 1 ? '1 hour ago' : `${diffHours} hours ago`;
			} else if (diffDays === 1) {
				return 'Yesterday';
			} else if (diffDays < 7) {
				return `${diffDays} days ago`;
			} else if (diffDays < 30) {
				const weeks = Math.floor(diffDays / 7);
				return weeks === 1 ? '1 week ago' : `${weeks} weeks ago`;
			} else {
				return date.toLocaleDateString();
			}
		}

		// Load more events button
		document.getElementById('loadMoreEvents').addEventListener('click', function() {
			loadTimelineEvents(timelineOffset, true);
		});

		// Load data when page loads
		loadPregnancyData();
		loadTimelineEvents();
		loadMilestones();
	</script>

	<!-- Update Modal -->
	<div id="updateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
		<div class="card max-w-lg w-full max-h-[90vh] overflow-y-auto">
			<div class="p-6">
				<div class="flex justify-between items-center mb-6">
					<h3 class="text-xl font-semibold text-gray-900">Post an Update</h3>
					<button onclick="closeUpdateModal()" class="text-gray-400 hover:text-gray-600">
						<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
						</svg>
					</button>
				</div>

				<form id="updateForm" onsubmit="submitUpdate(event)">
					<!-- Update Title -->
					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
						<input type="text" name="title" required
							class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
							placeholder="e.g., 20 Week Ultrasound">
					</div>

					<!-- Update Date -->
					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
						<input type="date" name="updateDate" 
							class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
						<p class="text-xs text-gray-500 mt-1">Leave blank to use today's date</p>
					</div>

					<!-- Milestone Dropdown -->
					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 mb-2">Related Milestone (optional)</label>
						<select name="milestone" 
							class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
							<option value="">Select a milestone</option>
							<option value="first_appointment">First Appointment</option>
							<option value="12_week_scan">12 Week Scan</option>
							<option value="20_week_scan">20 Week Anatomy Scan</option>
							<option value="28_week_checkup">28 Week Checkup</option>
							<option value="32_week_checkup">32 Week Checkup</option>
							<option value="36_week_checkup">36 Week Checkup</option>
							<option value="38_week_checkup">38 Week Checkup</option>
							<option value="40_week_checkup">40 Week Checkup</option>
							<option value="ultrasound">Ultrasound</option>
							<option value="bloodwork">Bloodwork</option>
							<option value="other">Other Appointment</option>
						</select>
					</div>

					<!-- Notes -->
					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
						<textarea name="content" rows="4"
							class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
							placeholder="Share how you're feeling, what happened at the appointment, etc."></textarea>
					</div>

					<!-- Photo Upload -->
					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 mb-2">Photos</label>
						<input type="file" name="photos" accept="image/*" multiple
							class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
						<p class="text-xs text-gray-500 mt-1">Select up to 5 photos (max 10MB each)</p>
					</div>

					<!-- Video Upload -->
					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 mb-2">Videos</label>
						<input type="file" name="videos" accept="video/mp4,video/quicktime,.mp4,.mov" multiple
							class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
						<p class="text-xs text-gray-500 mt-1">Select up to 3 videos (.mp4 or .mov, max 50MB each)</p>
					</div>

					<!-- Share with Village -->
					<div class="mb-6">
						<label class="flex items-center">
							<input type="checkbox" name="isShared" checked
								class="w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500">
							<span class="ml-2 text-sm text-gray-700">Share with your village</span>
						</label>
					</div>

					<!-- Buttons -->
					<div class="flex gap-3">
						<button type="submit" class="btn-primary flex-1">Post Update</button>
						<button type="button" onclick="closeUpdateModal()" class="btn-secondary flex-1">Cancel</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<!-- Edit Update Modal -->
	<div id="editUpdateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
		<div class="card max-w-lg w-full max-h-[90vh] overflow-y-auto">
			<div class="p-6">
				<div class="flex justify-between items-center mb-6">
					<h3 class="text-xl font-semibold text-gray-900">Edit Update</h3>
					<button onclick="closeEditUpdateModal()" class="text-gray-400 hover:text-gray-600">
						<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
						</svg>
					</button>
				</div>

				<form id="editUpdateForm" onsubmit="submitEditUpdate(event)">
					<!-- Update Title -->
					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
						<input type="text" name="title" required
							class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
							placeholder="e.g., 20 Week Ultrasound">
					</div>

					<!-- Update Date -->
					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
						<input type="date" name="updateDate" 
							class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
						<p class="text-xs text-gray-500 mt-1">Leave blank to use today's date</p>
					</div>

					<!-- Milestone Dropdown -->
					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 mb-2">Related Milestone (optional)</label>
						<select name="milestone" 
							class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
							<option value="">Select a milestone</option>
							<option value="first_appointment">First Appointment</option>
							<option value="12_week_scan">12 Week Scan</option>
							<option value="20_week_scan">20 Week Anatomy Scan</option>
							<option value="28_week_checkup">28 Week Checkup</option>
							<option value="32_week_checkup">32 Week Checkup</option>
							<option value="36_week_checkup">36 Week Checkup</option>
							<option value="38_week_checkup">38 Week Checkup</option>
							<option value="40_week_checkup">40 Week Checkup</option>
							<option value="ultrasound">Ultrasound</option>
							<option value="bloodwork">Bloodwork</option>
							<option value="other">Other Appointment</option>
						</select>
					</div>

					<!-- Notes -->
					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
						<textarea name="content" rows="4"
							class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
							placeholder="Share how you're feeling, what happened at the appointment, etc."></textarea>
					</div>

					<!-- Existing Media Display -->
					<div id="existingMedia" class="mb-4" style="display: none;">
						<label class="block text-sm font-medium text-gray-700 mb-2">Current Photos & Videos</label>
						<div id="existingMediaGrid" class="grid grid-cols-3 gap-2 mb-3"></div>
					</div>

					<!-- Photo Upload -->
					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 mb-2">Add Photos</label>
						<input type="file" name="photos" accept="image/*" multiple
							class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
						<p class="text-xs text-gray-500 mt-1">Select up to 5 additional photos (max 10MB each)</p>
					</div>

					<!-- Video Upload -->
					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 mb-2">Add Videos</label>
						<input type="file" name="videos" accept="video/mp4,video/quicktime,.mp4,.mov" multiple
							class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
						<p class="text-xs text-gray-500 mt-1">Select up to 3 additional videos (.mp4 or .mov, max 50MB each)</p>
					</div>

					<!-- Share with Village -->
					<div class="mb-6">
						<label class="flex items-center">
							<input type="checkbox" name="isShared" checked
								class="w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500">
							<span class="ml-2 text-sm text-gray-700">Share with your village</span>
						</label>
					</div>

					<!-- Buttons -->
					<div class="flex gap-3">
						<button type="submit" class="btn-primary flex-1">Update</button>
						<button type="button" onclick="closeEditUpdateModal()" class="btn-secondary flex-1">Cancel</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<script>
		// Update Modal Functions
		function showUpdateModal() {
			const modal = document.getElementById('updateModal');
			const dateInput = modal.querySelector('input[name="updateDate"]');
			
			// Set default date to today
			const today = new Date();
			const todayStr = today.getFullYear() + '-' + 
				String(today.getMonth() + 1).padStart(2, '0') + '-' + 
				String(today.getDate()).padStart(2, '0');
			dateInput.value = todayStr;
			
			modal.classList.remove('hidden');
			document.body.style.overflow = 'hidden';
		}

		function closeUpdateModal() {
			document.getElementById('updateModal').classList.add('hidden');
			document.body.style.overflow = '';
			document.getElementById('updateForm').reset();
		}

		async function submitUpdate(event) {
			event.preventDefault();
			
			const form = event.target;
			const formData = new FormData();
			
			// Get current pregnancy week
			let weekNumber = null;
			const weekText = document.getElementById('currentWeek').textContent;
			if (weekText && weekText !== '--') {
				weekNumber = parseInt(weekText);
			}

			// Handle custom date - convert to UTC ISO string
			let updateDate = null;
			if (form.updateDate.value) {
				// Create date in local timezone and convert to UTC
				const localDate = new Date(form.updateDate.value + 'T00:00:00');
				updateDate = localDate.toISOString();
			}

			// Prepare update data
			const updateData = {
				title: form.title.value,
				content: form.content.value || null,
				week_number: weekNumber,
				update_type: form.milestone.value ? 'appointment' : 'general',
				appointment_type: form.milestone.value || null,
				is_shared: form.isShared.checked,
				date: updateDate
			};

			formData.append('data', JSON.stringify(updateData));

			// Add photos if selected
			const photoFiles = form.photos.files;
			for (let i = 0; i < photoFiles.length && i < 5; i++) {
				formData.append('photos', photoFiles[i]);
			}

			// Add videos if selected
			const videoFiles = form.videos.files;
			for (let i = 0; i < videoFiles.length && i < 3; i++) {
				formData.append('videos', videoFiles[i]);
			}

			try {
				const response = await fetch('/api/updates', {
					method: 'POST',
					headers: {
						'Authorization': 'Bearer ' + token
					},
					body: formData
				});

				if (response.ok) {
					const update = await response.json();
					closeUpdateModal();
					// Reload timeline to show new update
					loadTimelineEvents();
					showSuccess('Update posted successfully!');
				} else {
					const error = await response.text();
					showError('Failed to post update: ' + error);
				}
			} catch (err) {
				console.error('Error posting update:', err);
				showError('Network error posting update');
			}
		}

		function showSuccess(message) {
			// Create a simple toast notification
			const toast = document.createElement('div');
			toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
			toast.textContent = message;
			document.body.appendChild(toast);
			
			setTimeout(() => {
				toast.remove();
			}, 3000);
		}

		// Load milestones for the dropdown
		async function loadMilestones() {
			// This will be implemented when milestone endpoints are ready
			// For now using static list in the dropdown
		}

		// Edit Update Functions
		let currentEditUpdateId = null;
		let currentEditPregnancyId = null;

		async function editUpdate(updateId) {
			currentEditUpdateId = updateId;
			
			try {
				// Get the update data from the timeline (we'll use the event data already loaded)
				const timelineEvents = document.querySelectorAll('#timelineContainer > div');
				let updateData = null;
				
				// Find the update in the current timeline
				for (const eventDiv of timelineEvents) {
					const editButton = eventDiv.querySelector(`button[onclick="editUpdate(${updateId})"]`);
					if (editButton) {
						// Extract data from the timeline event - we need to get fresh data from API
						break;
					}
				}
				
				// Fetch fresh update data from API
				const response = await fetch(`/api/updates?pregnancy_id`, {
					headers: {
						'Authorization': 'Bearer ' + token
					}
				});
				
				if (!response.ok) {
					showError('Failed to load update data');
					return;
				}
				
				const updates = await response.json();
				updateData = updates.find(u => u.id === updateId);
				
				if (!updateData) {
					showError('Update not found');
					return;
				}
				
				// Store pregnancy ID for media paths
				currentEditPregnancyId = updateData.pregnancy_id;
				
				// Populate the edit form
				const form = document.getElementById('editUpdateForm');
				form.title.value = updateData.title || '';
				form.content.value = updateData.content || '';
				form.isShared.checked = updateData.is_shared || false;
				
				// Set date
				if (updateData.update_date) {
					const date = new Date(updateData.update_date);
					const dateStr = date.getFullYear() + '-' + 
						String(date.getMonth() + 1).padStart(2, '0') + '-' + 
						String(date.getDate()).padStart(2, '0');
					form.updateDate.value = dateStr;
				}
				
				// Set milestone
				if (updateData.appointment_type) {
					form.milestone.value = updateData.appointment_type;
				} else {
					form.milestone.value = '';
				}
				
				// Show existing media
				displayExistingMedia(updateData.photos || []);
				
				// Show the modal
				document.getElementById('editUpdateModal').classList.remove('hidden');
				document.body.style.overflow = 'hidden';
				
			} catch (err) {
				console.error('Error loading update:', err);
				showError('Failed to load update data');
			}
		}

		function displayExistingMedia(photos) {
			const mediaContainer = document.getElementById('existingMediaGrid');
			const mediaSection = document.getElementById('existingMedia');
			
			if (!photos || photos.length === 0) {
				mediaSection.style.display = 'none';
				return;
			}
			
			mediaSection.style.display = 'block';
			
			mediaContainer.innerHTML = photos.map(photo => {
				const ext = photo.filename.toLowerCase().split('.').pop();
				const isVideo = ['mp4', 'mov'].includes(ext);
				const path = isVideo ? 'videos' : 'images';
				
				if (isVideo) {
					return `
						<div class="aspect-square bg-gray-100 rounded-lg overflow-hidden relative">
							<video class="w-full h-full object-cover" preload="metadata">
								<source src="/${path}/${currentEditPregnancyId}/${photo.filename}#t=0.5" type="video/${ext === 'mov' ? 'quicktime' : 'mp4'}">
							</video>
							<div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-30">
								<div class="w-6 h-6 bg-white bg-opacity-90 rounded-full flex items-center justify-center">
									<svg class="w-3 h-3 text-gray-800" fill="currentColor" viewBox="0 0 20 20">
										<path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/>
									</svg>
								</div>
							</div>
						</div>
					`;
				} else {
					return `
						<div class="aspect-square bg-gray-100 rounded-lg overflow-hidden">
							<img src="/${path}/${currentEditPregnancyId}/${photo.filename}" 
								 alt="${photo.original_filename}"
								 class="w-full h-full object-cover"
								 loading="lazy">
						</div>
					`;
				}
			}).join('');
		}

		function closeEditUpdateModal() {
			document.getElementById('editUpdateModal').classList.add('hidden');
			document.body.style.overflow = '';
			document.getElementById('editUpdateForm').reset();
			currentEditUpdateId = null;
			currentEditPregnancyId = null;
			document.getElementById('existingMedia').style.display = 'none';
		}

		async function submitEditUpdate(event) {
			event.preventDefault();
			
			if (!currentEditUpdateId) {
				showError('No update selected for editing');
				return;
			}
			
			const form = event.target;
			const formData = new FormData();
			
			// Get current pregnancy week
			let weekNumber = null;
			const weekText = document.getElementById('currentWeek').textContent;
			if (weekText && weekText !== '--') {
				weekNumber = parseInt(weekText);
			}

			// Handle custom date - convert to UTC ISO string
			let updateDate = null;
			if (form.updateDate.value) {
				const localDate = new Date(form.updateDate.value + 'T00:00:00');
				updateDate = localDate.toISOString();
			}

			// Prepare update data
			const updateData = {
				title: form.title.value,
				content: form.content.value || null,
				week_number: weekNumber,
				update_type: form.milestone.value ? 'appointment' : 'general',
				appointment_type: form.milestone.value || null,
				is_shared: form.isShared.checked,
				date: updateDate
			};

			formData.append('data', JSON.stringify(updateData));

			// Add photos if selected
			const photoFiles = form.photos.files;
			for (let i = 0; i < photoFiles.length && i < 5; i++) {
				formData.append('photos', photoFiles[i]);
			}

			// Add videos if selected
			const videoFiles = form.videos.files;
			for (let i = 0; i < videoFiles.length && i < 3; i++) {
				formData.append('videos', videoFiles[i]);
			}

			try {
				const response = await fetch(`/api/updates/${currentEditUpdateId}`, {
					method: 'PUT',
					headers: {
						'Authorization': 'Bearer ' + token
					},
					body: formData
				});

				if (response.ok) {
					const update = await response.json();
					closeEditUpdateModal();
					// Reload timeline to show updated update
					loadTimelineEvents();
					showSuccess('Update saved successfully!');
				} else {
					const error = await response.text();
					showError('Failed to update: ' + error);
				}
			} catch (err) {
				console.error('Error updating:', err);
				showError('Network error updating');
			}
		}

		// Media modal functions
		function openPhotoModal(imageSrc, originalName) {
			const modal = document.getElementById('photoModal');
			const img = document.getElementById('photoModalImage');
			const caption = document.getElementById('photoModalCaption');
			
			img.src = imageSrc;
			caption.textContent = originalName || 'Photo';
			modal.classList.remove('hidden');
			document.body.style.overflow = 'hidden';
		}

		function openVideoModal(videoSrc, originalName) {
			const modal = document.getElementById('videoModal');
			const video = document.getElementById('videoModalVideo');
			const caption = document.getElementById('videoModalCaption');
			
			video.src = videoSrc;
			caption.textContent = originalName || 'Video';
			modal.classList.remove('hidden');
			document.body.style.overflow = 'hidden';
		}

		function closePhotoModal() {
			const modal = document.getElementById('photoModal');
			modal.classList.add('hidden');
			document.body.style.overflow = '';
		}

		function closeVideoModal() {
			const modal = document.getElementById('videoModal');
			const video = document.getElementById('videoModalVideo');
			video.pause();
			video.src = '';
			modal.classList.add('hidden');
			document.body.style.overflow = '';
		}

		// Close modals when clicking outside
		function handlePhotoModalClick(event) {
			if (event.target.id === 'photoModal') {
				closePhotoModal();
			}
		}

		function handleVideoModalClick(event) {
			if (event.target.id === 'videoModal') {
				closeVideoModal();
			}
		}

		// Cover Photo Functions
		function showCoverPhotoModal() {
			updateCoverPhotoModal();
			document.getElementById('coverPhotoModal').classList.remove('hidden');
			document.body.style.overflow = 'hidden';
		}

		function closeCoverPhotoModal() {
			document.getElementById('coverPhotoModal').classList.add('hidden');
			document.body.style.overflow = '';
		}

		function updateCoverPhotoModal() {
			const currentPhotoDiv = document.getElementById('currentCoverPhoto');
			const noPhotoDiv = document.getElementById('noCoverPhoto');
			const currentPhotoImage = document.getElementById('currentCoverPhotoImage');
			const brokenImagePlaceholder = document.getElementById('brokenImagePlaceholder');
			
			// Check if cover photo exists in the welcome section
			const welcomeCoverPhoto = document.getElementById('coverPhotoImage');
			const hasCoverPhoto = welcomeCoverPhoto && welcomeCoverPhoto.src && !welcomeCoverPhoto.src.includes('data:');
			
			if (hasCoverPhoto) {
				currentPhotoDiv.classList.remove('hidden');
				noPhotoDiv.classList.add('hidden');
				
				// Reset error state
				currentPhotoImage.classList.remove('hidden');
				brokenImagePlaceholder.classList.add('hidden');
				
				// Load the image
				currentPhotoImage.src = welcomeCoverPhoto.src;
			} else {
				currentPhotoDiv.classList.add('hidden');
				noPhotoDiv.classList.remove('hidden');
			}
		}

		function handleCoverPhotoError(img) {
			// Hide the broken image and show placeholder
			img.classList.add('hidden');
			document.getElementById('brokenImagePlaceholder').classList.remove('hidden');
		}

		async function uploadCoverPhoto(file) {
			const formData = new FormData();
			formData.append('cover_photo', file);
			
			// Show progress
			document.getElementById('coverPhotoUploadProgress').classList.remove('hidden');
			
			try {
				const response = await fetch('/api/cover-photo', {
					method: 'POST',
					headers: {
						'Authorization': 'Bearer ' + token
					},
					body: formData
				});
				
				if (response.ok) {
					// Reload pregnancy data to update the welcome section
					await loadPregnancyData();
					// Update the modal display
					updateCoverPhotoModal();
					showSuccess('Cover photo updated successfully!');
				} else {
					const errorText = await response.text();
					showError(errorText || 'Failed to upload cover photo');
				}
			} catch (error) {
				showError('Network error uploading cover photo');
			} finally {
				document.getElementById('coverPhotoUploadProgress').classList.add('hidden');
			}
		}

		async function deleteCoverPhoto() {
			try {
				const response = await fetch('/api/cover-photo', {
					method: 'DELETE',
					headers: {
						'Authorization': 'Bearer ' + token
					}
				});
				
				if (response.ok) {
					// Reload pregnancy data to update the welcome section
					await loadPregnancyData();
					// Update the modal display
					updateCoverPhotoModal();
					showSuccess('Cover photo removed successfully!');
				} else {
					const errorText = await response.text();
					showError(errorText || 'Failed to remove cover photo');
				}
			} catch (error) {
				showError('Network error removing cover photo');
			}
		}

		function showSuccess(message) {
			console.log('Success:', message);
			// Could add a toast notification here
		}

		// Set up file input event listener for cover photo
		document.addEventListener('DOMContentLoaded', function() {
			document.getElementById('coverPhotoInput').addEventListener('change', function(e) {
				const file = e.target.files[0];
				if (file) {
					uploadCoverPhoto(file);
				}
			});
		});
	</script>

	<!-- Photo Modal -->
	<div id="photoModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4" onclick="handlePhotoModalClick(event)">
		<div class="max-w-4xl max-h-full flex flex-col">
			<div class="flex justify-between items-center mb-4">
				<h3 id="photoModalCaption" class="text-white text-lg font-medium"></h3>
				<button onclick="closePhotoModal()" class="text-white hover:text-gray-300">
					<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
					</svg>
				</button>
			</div>
			<div class="flex-1 flex items-center justify-center">
				<img id="photoModalImage" class="max-w-full max-h-full object-contain rounded-lg" alt="Photo">
			</div>
		</div>
	</div>

	<!-- Video Modal -->
	<div id="videoModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4" onclick="handleVideoModalClick(event)">
		<div class="max-w-4xl max-h-full flex flex-col">
			<div class="flex justify-between items-center mb-4">
				<h3 id="videoModalCaption" class="text-white text-lg font-medium"></h3>
				<button onclick="closeVideoModal()" class="text-white hover:text-gray-300">
					<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
					</svg>
				</button>
			</div>
			<div class="flex-1 flex items-center justify-center">
				<video id="videoModalVideo" class="max-w-full max-h-full rounded-lg" controls>
					Your browser does not support the video tag.
				</video>
			</div>
		</div>
	</div>

	<!-- Cover Photo Modal -->
	<div id="coverPhotoModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
		<div class="card max-w-md w-full">
			<div class="p-6">
				<div class="flex justify-between items-center mb-6">
					<h3 class="text-xl font-semibold text-gray-900">Cover Photo</h3>
					<button onclick="closeCoverPhotoModal()" class="text-gray-400 hover:text-gray-600">
						<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
						</svg>
					</button>
				</div>

				<div id="coverPhotoContent">
					<!-- Current Photo -->
					<div id="currentCoverPhoto" class="mb-6">
						<div class="relative">
							<img id="currentCoverPhotoImage" src="" alt="Current cover photo" 
								 class="w-full h-48 object-cover rounded-lg"
								 onerror="handleCoverPhotoError(this)">
							<!-- Placeholder for broken images -->
							<div id="brokenImagePlaceholder" class="hidden absolute inset-0 bg-gray-100 rounded-lg flex items-center justify-center">
								<div class="text-center">
									<svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
										<path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
									</svg>
									<p class="mt-2 text-sm text-gray-500">Image not found</p>
								</div>
							</div>
						</div>
						<div class="flex justify-center mt-3">
							<button onclick="deleteCoverPhoto()" class="text-red-600 hover:text-red-700 text-sm">
								Remove Photo
							</button>
						</div>
					</div>
					
					<!-- No Photo State -->
					<div id="noCoverPhoto" class="text-center mb-6">
						<svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
							<path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
						</svg>
						<p class="mt-2 text-sm text-gray-600">No cover photo set</p>
					</div>

					<!-- Upload Section -->
					<div class="space-y-4">
						<input type="file" id="coverPhotoInput" accept="image/*" class="hidden">
						<button type="button" onclick="document.getElementById('coverPhotoInput').click()" 
								class="w-full px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
							Choose New Photo
						</button>
						
						<!-- Upload Progress -->
						<div id="coverPhotoUploadProgress" class="hidden">
							<div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
								<div class="flex items-center">
									<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
										<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
										<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
									</svg>
									<span class="text-blue-800">Uploading photo...</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>
