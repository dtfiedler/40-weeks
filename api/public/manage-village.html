<!DOCTYPE html>
<html>
<head>
	<title>Manage Your Village - 40Weeks</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Manage your pregnancy village members">
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = {
			theme: {
				extend: {
					fontFamily: {
						'sans': ['Poppins', 'system-ui', 'sans-serif'],
						'serif': ['DM Serif Display', 'serif'],
					},
					colors: {
						primary: {
							50: '#fffbeb',
							100: '#fef3c7',
							200: '#fde68a',
							300: '#fcd34d',
							400: '#fbbf24',
							500: '#f59e0b',
							600: '#d97706',
							700: '#b45309',
							800: '#92400e',
							900: '#78350f'
						}
					}
				}
			}
		}
	</script>
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
	<style>
		/* Shadcn-inspired custom styles */
		:root {
			--background: 0 0% 100%;
			--foreground: 240 10% 3.9%;
			--card: 0 0% 100%;
			--card-foreground: 240 10% 3.9%;
			--primary: 240 5.9% 10%;
			--primary-foreground: 0 0% 98%;
			--secondary: 240 4.8% 95.9%;
			--secondary-foreground: 240 5.9% 10%;
			--muted: 240 4.8% 95.9%;
			--muted-foreground: 240 3.8% 46.1%;
			--border: 240 5.9% 90%;
			--input: 240 5.9% 90%;
			--ring: 240 10% 3.9%;
			--radius: 0.5rem;
		}

		body {
			font-family: 'Poppins', sans-serif;
			background-color: hsl(var(--background));
			color: hsl(var(--foreground));
		}

		.card {
			background-color: hsl(var(--card));
			color: hsl(var(--card-foreground));
			border-radius: var(--radius);
			border: 1px solid hsl(var(--border));
			box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
		}

		.btn-primary {
			background-color: hsl(var(--primary));
			color: hsl(var(--primary-foreground));
			border: 1px solid hsl(var(--primary));
			border-radius: calc(var(--radius) - 2px);
			padding: 0.75rem 1.5rem;
			font-size: 0.875rem;
			font-weight: 500;
			transition: all 0.2s;
		}

		.btn-primary:hover {
			background-color: hsl(var(--primary) / 0.9);
		}

		.btn-secondary {
			background-color: transparent;
			color: hsl(var(--foreground));
			border: 1px solid hsl(var(--border));
			border-radius: calc(var(--radius) - 2px);
			padding: 0.75rem 1.5rem;
			font-size: 0.875rem;
			font-weight: 500;
			transition: all 0.2s;
		}

		.btn-secondary:hover {
			background-color: hsl(var(--muted));
		}

		.toggle-switch {
			position: relative;
			display: inline-block;
			width: 60px;
			height: 34px;
		}

		.toggle-switch input {
			opacity: 0;
			width: 0;
			height: 0;
		}

		.slider {
			position: absolute;
			cursor: pointer;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: #ccc;
			transition: .4s;
			border-radius: 34px;
		}

		.slider:before {
			position: absolute;
			content: "";
			height: 26px;
			width: 26px;
			left: 4px;
			bottom: 4px;
			background-color: white;
			transition: .4s;
			border-radius: 50%;
		}

		input:checked + .slider {
			background-color: #10b981;
		}

		input:checked + .slider:before {
			transform: translateX(26px);
		}
	</style>
</head>
<body class="bg-gray-50">
	<!-- Header -->
	<header class="bg-white border-b border-gray-200 sticky top-0 z-10">
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
			<div class="flex justify-between items-center h-16">
				<div class="flex items-center">
					<button onclick="goBack()" class="mr-4 p-2 hover:bg-gray-100 rounded-lg">
						<svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
						</svg>
					</button>
					<h1 class="text-xl font-semibold text-gray-900 font-serif">Your Village</h1>
				</div>
				<div class="flex items-center space-x-4">
					<button onclick="logout()" class="text-sm text-gray-500 hover:text-gray-700">
						Sign out
					</button>
				</div>
			</div>
		</div>
	</header>

	<!-- Main Content -->
	<main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
		<!-- Village Stats -->
		<div class="mb-8">
			<div class="card p-6">
				<div class="flex items-center justify-between">
					<div>
						<h2 class="text-2xl font-bold text-gray-900 font-serif">Your Village</h2>
						<p class="text-gray-600 mt-1" id="villageDescription">Loading...</p>
					</div>
					<div class="text-right">
						<div class="text-3xl font-bold text-primary-600" id="villageCount">--</div>
						<div class="text-gray-500 text-sm">people following</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Village Members List -->
		<div class="card">
			<div class="p-6 border-b border-gray-200">
				<div class="flex items-center justify-between">
					<h3 class="text-lg font-semibold text-gray-900">Village Members</h3>
					<button onclick="toggleAddForm()" class="btn-primary" id="addButton">
						+ Add
					</button>
				</div>
			</div>
			
			<!-- Add Member Form (hidden by default) -->
			<div id="addMemberForm" class="hidden border-b border-gray-200 p-6 bg-gray-50">
				<div class="max-w-2xl">
					<h4 class="text-lg font-medium text-gray-900 mb-4">Add New Member</h4>
					<form id="memberForm" class="space-y-4">
						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<div>
								<label class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
								<input type="text" id="memberName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" placeholder="John Smith" required>
							</div>
							<div>
								<label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
								<input type="email" id="memberEmail" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" placeholder="john@example.com" required>
							</div>
						</div>
						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<div>
								<label class="block text-sm font-medium text-gray-700 mb-1">Relationship *</label>
								<select id="memberRelationship" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" required>
									<option value="">Select relationship</option>
									<option value="mother">Mother</option>
									<option value="father">Father</option>
									<option value="parents">Parents (both)</option>
									<option value="mother-in-law">Mother-in-law</option>
									<option value="father-in-law">Father-in-law</option>
									<option value="in-laws">In-laws (both)</option>
									<option value="sister">Sister</option>
									<option value="brother">Brother</option>
									<option value="siblings">Siblings</option>
									<option value="friend">Friend</option>
									<option value="friends">Friends</option>
									<option value="coworker">Coworker</option>
									<option value="other">Other</option>
								</select>
							</div>
							<div class="flex items-end">
								<label class="flex items-center">
									<input type="checkbox" id="memberKnows" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
									<span class="ml-2 text-sm text-gray-700">They know about the pregnancy</span>
								</label>
							</div>
						</div>
						<div class="flex items-center space-x-3 pt-2">
							<button type="submit" class="btn-primary">
								Add Member
							</button>
							<button type="button" onclick="cancelAddForm()" class="btn-secondary">
								Cancel
							</button>
						</div>
					</form>
				</div>
			</div>
			
			<div id="villageList" class="divide-y divide-gray-200">
				<!-- Village members will be loaded here -->
				<div class="p-6 text-center text-gray-500">
					<div class="animate-pulse">Loading your village...</div>
				</div>
			</div>
			
			<!-- Pagination -->
			<div id="pagination"></div>
		</div>

		<!-- Additional Actions -->
		<div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
			<div class="card p-6 text-center">
				<div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mx-auto mb-4">
					<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
					</svg>
				</div>
				<h3 class="text-lg font-semibold text-gray-900 mb-2">Share Your Journey</h3>
				<p class="text-gray-600 text-sm mb-4">Get your shareable link to invite more people to your village</p>
				<button onclick="copyInviteLink()" class="btn-secondary w-full">
					Copy Invite Link
				</button>
			</div>

			<div class="card p-6 text-center">
				<div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mx-auto mb-4">
					<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
					</svg>
				</div>
				<h3 class="text-lg font-semibold text-gray-900 mb-2">Post an Update</h3>
				<p class="text-gray-600 text-sm mb-4">Share photos and news with your village members</p>
				<button onclick="postUpdate()" class="btn-primary w-full">
					Create Update
				</button>
			</div>

			<div class="card p-6 text-center">
				<div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mx-auto mb-4">
					<svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
					</svg>
				</div>
				<h3 class="text-lg font-semibold text-gray-900 mb-2">View Your App</h3>
				<p class="text-gray-600 text-sm mb-4">Go back to your main pregnancy dashboard</p>
				<button onclick="goBack()" class="btn-secondary w-full">
					Back to App
				</button>
			</div>
		</div>

	</main>

	<!-- Success/Error Messages -->
	<div id="error" class="hidden fixed top-4 right-4 z-50">
		<div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-md text-sm max-w-sm">
			<span id="error-message"></span>
		</div>
	</div>

	<div id="success" class="hidden fixed top-4 right-4 z-50">
		<div class="bg-green-50 border border-green-200 text-green-600 px-4 py-3 rounded-md text-sm max-w-sm">
			<span id="success-message"></span>
		</div>
	</div>

	<script>
		const token = localStorage.getItem('jwt_token');
		let villageMembers = [];
		let currentPage = 1;
		const membersPerPage = 10;
		
		if (!token) {
			window.location.href = '/login';
		}

		// Load village members on page load
		async function loadVillageMembers() {
			try {
				const response = await fetch('/api/village-members', {
					headers: {
						'Authorization': 'Bearer ' + token
					}
				});
				
				if (response.ok) {
					villageMembers = await response.json();
					renderVillageList();
					updateVillageStats();
				} else {
					showError('Failed to load village members');
				}
			} catch (err) {
				showError('Network error loading village members');
			}
		}

		function calculateVillageCount(members) {
			let totalCount = 0;
			
			const doubleCountRelationships = [
				'parents', 'in-laws', 'friends', 'siblings'
			];
			
			const coupleRelationships = [
				'mother', 'father', 'mother-in-law', 'father-in-law', 'friend'
			];
			
			members.forEach(member => {
				const relationship = member.relationship;
				
				if (doubleCountRelationships.includes(relationship) || 
				    coupleRelationships.includes(relationship)) {
					totalCount += 2;
				} else {
					totalCount += 1;
				}
			});
			
			return totalCount;
		}

		function updateVillageStats() {
			const totalCount = calculateVillageCount(villageMembers);
			const knowsCount = calculateVillageCount(villageMembers.filter(m => m.is_told));
			
			document.getElementById('villageCount').textContent = totalCount;
			
			const description = document.getElementById('villageDescription');
			if (totalCount === 0) {
				description.textContent = "Your village is empty. Add some people to get started!";
			} else {
				description.textContent = `${knowsCount} of ${totalCount} people know about your pregnancy`;
			}
		}

		function renderVillageList() {
			const villageList = document.getElementById('villageList');
			
			if (villageMembers.length === 0) {
				villageList.innerHTML = `
					<div class="p-8 text-center text-gray-500">
						<svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
						</svg>
						<p class="mb-4">Your village is empty</p>
						<button onclick="toggleAddForm()" class="btn-primary">Add Your First Member</button>
					</div>
				`;
				return;
			}

			// Calculate pagination
			const totalPages = Math.ceil(villageMembers.length / membersPerPage);
			const startIndex = (currentPage - 1) * membersPerPage;
			const endIndex = startIndex + membersPerPage;
			const currentMembers = villageMembers.slice(startIndex, endIndex);

			// Render current page members
			villageList.innerHTML = currentMembers.map(member => `
				<div class="p-6 flex items-center justify-between">
					<div class="flex items-center">
						<div class="w-12 h-12 ${getRelationshipColor(member.relationship)} rounded-full flex items-center justify-center text-white text-lg font-medium mr-4">
							${member.name.charAt(0).toUpperCase()}
						</div>
						<div>
							<p class="font-semibold text-gray-900">${member.name}</p>
							<p class="text-sm text-gray-500">${member.email}</p>
							<p class="text-sm text-gray-400">${capitalizeFirst(member.relationship)}</p>
						</div>
					</div>
					<div class="flex items-center space-x-4">
						<div class="flex items-center space-x-3">
							<span class="text-sm text-gray-600">Knows:</span>
							<label class="toggle-switch">
								<input type="checkbox" ${member.is_told ? 'checked' : ''} 
									   onchange="toggleMemberStatus(${member.id}, this.checked)">
								<span class="slider"></span>
							</label>
						</div>
						<button onclick="removeMember(${member.id})" 
								class="text-red-500 hover:text-red-700 p-2 hover:bg-red-50 rounded-lg">
							<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
							</svg>
						</button>
					</div>
				</div>
			`).join('');

			// Render pagination if needed
			renderPagination(totalPages);
		}

		function renderPagination(totalPages) {
			const paginationContainer = document.getElementById('pagination');
			
			if (totalPages <= 1) {
				paginationContainer.innerHTML = '';
				return;
			}

			let paginationHTML = `
				<div class="flex items-center justify-between px-6 py-4 border-t border-gray-200">
					<div class="text-sm text-gray-700">
						Showing ${(currentPage - 1) * membersPerPage + 1} to ${Math.min(currentPage * membersPerPage, villageMembers.length)} of ${villageMembers.length} members
					</div>
					<div class="flex items-center space-x-2">
			`;

			// Previous button
			if (currentPage > 1) {
				paginationHTML += `
					<button onclick="changePage(${currentPage - 1})" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
						Previous
					</button>
				`;
			}

			// Page numbers
			for (let i = 1; i <= totalPages; i++) {
				if (i === currentPage) {
					paginationHTML += `
						<button class="px-3 py-2 text-sm font-medium text-white bg-primary-600 border border-primary-600 rounded-md">
							${i}
						</button>
					`;
				} else if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
					paginationHTML += `
						<button onclick="changePage(${i})" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
							${i}
						</button>
					`;
				} else if (i === currentPage - 3 || i === currentPage + 3) {
					paginationHTML += `<span class="px-2 py-2 text-gray-400">...</span>`;
				}
			}

			// Next button
			if (currentPage < totalPages) {
				paginationHTML += `
					<button onclick="changePage(${currentPage + 1})" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
						Next
					</button>
				`;
			}

			paginationHTML += `
					</div>
				</div>
			`;

			paginationContainer.innerHTML = paginationHTML;
		}

		function changePage(page) {
			currentPage = page;
			renderVillageList();
		}

		async function toggleMemberStatus(memberId, isTold) {
			try {
				const response = await fetch(`/api/village-members/${memberId}`, {
					method: 'PUT',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': 'Bearer ' + token
					},
					body: JSON.stringify({ is_told: isTold })
				});
				
				if (response.ok) {
					const updatedMember = await response.json();
					
					// Update local data
					const memberIndex = villageMembers.findIndex(m => m.id === memberId);
					if (memberIndex !== -1) {
						villageMembers[memberIndex] = updatedMember;
						updateVillageStats();
					}
					
					showSuccess(`${updatedMember.name} ${isTold ? 'now knows' : 'marked as not knowing'} about your pregnancy`);
				} else {
					showError('Failed to update member status');
					// Revert the toggle
					loadVillageMembers();
				}
			} catch (err) {
				showError('Network error. Please try again.');
				loadVillageMembers();
			}
		}

		async function removeMember(memberId) {
			const member = villageMembers.find(m => m.id === memberId);
			if (!confirm(`Are you sure you want to remove ${member?.name} from your village?`)) {
				return;
			}

			try {
				const response = await fetch(`/api/village-members/${memberId}`, {
					method: 'DELETE',
					headers: {
						'Authorization': 'Bearer ' + token
					}
				});
				
				if (response.ok) {
					villageMembers = villageMembers.filter(member => member.id !== memberId);
					renderVillageList();
					updateVillageStats();
					showSuccess('Member removed from village');
				} else {
					showError('Failed to remove member');
				}
			} catch (err) {
				showError('Network error. Please try again.');
			}
		}

		function getRelationshipColor(relationship) {
			const colors = {
				'mother': 'bg-pink-500',
				'father': 'bg-blue-500',
				'parents': 'bg-purple-500',
				'mother-in-law': 'bg-purple-400',
				'father-in-law': 'bg-indigo-500',
				'in-laws': 'bg-indigo-400',
				'sister': 'bg-rose-500',
				'brother': 'bg-cyan-500',
				'siblings': 'bg-teal-500',
				'friend': 'bg-green-500',
				'friends': 'bg-green-400',
				'coworker': 'bg-orange-500',
				'other': 'bg-gray-500'
			};
			return colors[relationship] || 'bg-gray-500';
		}

		function capitalizeFirst(str) {
			return str.charAt(0).toUpperCase() + str.slice(1).replace('-', ' ');
		}

		function toggleAddForm() {
			const form = document.getElementById('addMemberForm');
			const button = document.getElementById('addButton');
			
			if (form.classList.contains('hidden')) {
				form.classList.remove('hidden');
				button.textContent = 'Cancel';
				button.onclick = cancelAddForm;
			} else {
				cancelAddForm();
			}
		}

		function cancelAddForm() {
			const form = document.getElementById('addMemberForm');
			const button = document.getElementById('addButton');
			
			form.classList.add('hidden');
			button.textContent = '+ Add';
			button.onclick = toggleAddForm;
			
			// Reset form
			document.getElementById('memberForm').reset();
		}

		async function submitMemberForm(event) {
			event.preventDefault();
			
			const name = document.getElementById('memberName').value.trim();
			const email = document.getElementById('memberEmail').value.trim();
			const relationship = document.getElementById('memberRelationship').value;
			const isTold = document.getElementById('memberKnows').checked;
			
			if (!name || !email || !relationship) {
				showError('Please fill in all required fields');
				return;
			}
			
			try {
				const response = await fetch('/api/village-members', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': 'Bearer ' + token
					},
					body: JSON.stringify({
						name: name,
						email: email,
						relationship: relationship,
						is_told: isTold
					})
				});
				
				if (response.ok) {
					const newMember = await response.json();
					villageMembers.push(newMember);
					renderVillageList();
					updateVillageStats();
					cancelAddForm();
					showSuccess(`${newMember.name} added to your village!`);
				} else {
					const errorText = await response.text();
					showError(`Failed to add member: ${errorText}`);
				}
			} catch (err) {
				showError('Network error. Please try again.');
			}
		}

		async function copyInviteLink() {
			try {
				const response = await fetch('/api/pregnancy/invite-hash', {
					headers: {
						'Authorization': 'Bearer ' + token
					}
				});
				
				if (response.ok) {
					const data = await response.json();
					const inviteLink = `${window.location.origin}/share/${data.hash}`;
					
					if (navigator.clipboard) {
						await navigator.clipboard.writeText(inviteLink);
						showSuccess('Invite link copied to clipboard!');
					} else {
						// Fallback for older browsers
						const textArea = document.createElement('textarea');
						textArea.value = inviteLink;
						document.body.appendChild(textArea);
						textArea.select();
						document.execCommand('copy');
						document.body.removeChild(textArea);
						showSuccess('Invite link copied to clipboard!');
					}
				} else {
					showError('Failed to get invite link');
				}
			} catch (err) {
				showError('Network error. Please try again.');
			}
		}

		function postUpdate() {
			showSuccess('Update posting feature coming soon!');
		}

		function goBack() {
			window.location.href = '/app';
		}

		function logout() {
			localStorage.removeItem('jwt_token');
			window.location.href = '/login';
		}

		function showError(message) {
			const errorDiv = document.getElementById('error');
			const errorMessage = document.getElementById('error-message');
			errorMessage.textContent = message;
			errorDiv.classList.remove('hidden');
			setTimeout(() => errorDiv.classList.add('hidden'), 5000);
		}

		function showSuccess(message) {
			const successDiv = document.getElementById('success');
			const successMessage = document.getElementById('success-message');
			successMessage.textContent = message;
			successDiv.classList.remove('hidden');
			setTimeout(() => successDiv.classList.add('hidden'), 3000);
		}

		// Load data when page loads
		loadVillageMembers();
		
		// Attach form handler
		document.getElementById('memberForm').addEventListener('submit', submitMemberForm);
	</script>
</body>
</html>