<!DOCTYPE html>
<html>
<head>
	<title>Pregnancy Timeline - 40Weeks</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Follow their pregnancy">
	
	<!-- Dynamic meta tags (will be updated by JavaScript) -->
	<meta property="og:title" content="Pregnancy Timeline - 40Weeks">
	<meta property="og:description" content="Follow their pregnancy">
	<meta property="og:type" content="website">
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:title" content="Pregnancy Timeline - 40Weeks">
	<meta name="twitter:description" content="Follow their pregnancy">
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = {
			theme: {
				extend: {
					fontFamily: {
						'sans': ['Poppins', 'system-ui', 'sans-serif'],
						'serif': ['DM Serif Display', 'serif'],
					},
					colors: {
						primary: {
							50: '#fffbeb',
							100: '#fef3c7',
							200: '#fde68a',
							300: '#fcd34d',
							400: '#fbbf24',
							500: '#f59e0b',
							600: '#d97706',
							700: '#b45309',
							800: '#92400e',
							900: '#78350f'
						}
					}
				}
			}
		}
	</script>
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
	<style>
		/* Shadcn-inspired custom styles */
		:root {
			--background: 0 0% 100%;
			--foreground: 240 10% 3.9%;
			--card: 0 0% 100%;
			--card-foreground: 240 10% 3.9%;
			--primary: 240 5.9% 10%;
			--primary-foreground: 0 0% 98%;
			--secondary: 240 4.8% 95.9%;
			--secondary-foreground: 240 5.9% 10%;
			--muted: 240 4.8% 95.9%;
			--muted-foreground: 240 3.8% 46.1%;
			--border: 240 5.9% 90%;
			--radius: 0.5rem;
		}

		body {
			font-family: 'Poppins', sans-serif;
			background-color: hsl(var(--background));
			color: hsl(var(--foreground));
		}

		.card {
			background-color: hsl(var(--card));
			color: hsl(var(--card-foreground));
			border-radius: var(--radius);
			border: 1px solid hsl(var(--border));
			box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
		}
	</style>
</head>
<body class="min-h-screen bg-gray-50">
	<!-- Header (hidden until access is verified) -->
	<header id="pregnancyHeader" class="hidden bg-white border-b border-gray-200">
		<div class="max-w-4xl mx-auto px-4 py-6">
			<div class="text-center">
				<h1 id="pregnancyTitle" class="text-3xl font-bold text-gray-900 font-serif">Pregnancy Journey</h1>
				<p id="pregnancySubtitle" class="text-gray-600 mt-2">Following the pregnancy journey</p>
			</div>
		</div>
	</header>

	<!-- Email Verification Form -->
	<div id="emailVerification" class="min-h-screen flex items-center justify-center px-4">
		<div class="max-w-md w-full">
		<div class="card p-6">
			<div class="text-center mb-6">
				<div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4">
					<svg class="w-8 h-8 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
					</svg>
				</div>
				<h2 class="text-2xl font-bold text-gray-900 mb-2 font-serif">Request to Follow</h2>
				<p class="text-gray-600">Please enter your email to view this pregnancy timeline</p>
			</div>
			
			<form id="emailVerificationForm" class="space-y-4">
				<div>
					<label for="emailInput" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
					<input 
						type="email" 
						id="emailInput" 
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" 
						placeholder="your@email.com"
						required
					>
				</div>
				
				<button 
					type="submit" 
					class="w-full bg-primary-500 text-white py-2 px-4 rounded-md hover:bg-primary-600 transition-colors font-medium"
				>
					Continue
				</button>
			</form>
			
			<div id="verificationError" class="hidden mt-4 p-3 bg-red-50 border border-red-200 text-red-600 rounded-md text-sm"></div>
			</div>
		</div>
	</div>

	<!-- Request Access Form -->
	<div id="requestAccess" class="hidden min-h-screen flex items-center justify-center px-4">
		<div class="max-w-md w-full">
		<div class="card p-6">
			<div class="text-center mb-6">
				<div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
					<svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
					</svg>
				</div>
				<h2 class="text-2xl font-bold text-gray-900 mb-2 font-serif">Access Required</h2>
				<p class="text-gray-600">You're not currently part of this pregnancy village. Request access to view updates!</p>
			</div>
			
			<form id="requestAccessForm" class="space-y-4">
				<div>
					<label for="requestName" class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
					<input 
						type="text" 
						id="requestName" 
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" 
						placeholder="Your name"
						required
					>
				</div>
				
				<div>
					<label for="requestRelationship" class="block text-sm font-medium text-gray-700 mb-1">Relationship</label>
					<select id="requestRelationship" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" required>
						<option value="">Select relationship</option>
						<option value="mother">Mother</option>
						<option value="father">Father</option>
						<option value="mother-in-law">Mother-in-law</option>
						<option value="father-in-law">Father-in-law</option>
						<option value="in-laws">In-laws (both)</option>
						<option value="sister">Sister</option>
						<option value="brother">Brother</option>
						<option value="friend">Friend</option>
						<option value="coworker">Coworker</option>
						<option value="other">Other</option>
					</select>
				</div>
				
				<div>
					<label for="requestMessage" class="block text-sm font-medium text-gray-700 mb-1">Message (Optional)</label>
					<textarea 
						id="requestMessage" 
						rows="3"
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" 
						placeholder="Hi! I'd love to follow your pregnancy journey..."
					></textarea>
				</div>
				
				<button 
					type="submit" 
					class="w-full bg-primary-500 text-white py-2 px-4 rounded-md hover:bg-primary-600 transition-colors font-medium"
				>
					Request Access
				</button>
				
				<button 
					type="button" 
					onclick="goBackToEmailVerification()"
					class="w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 transition-colors font-medium"
				>
					Use Different Email
				</button>
			</form>
			
			<div id="requestError" class="hidden mt-4 p-3 bg-red-50 border border-red-200 text-red-600 rounded-md text-sm"></div>
			</div>
		</div>
	</div>

	<!-- Access Request Sent -->
	<div id="requestSent" class="hidden min-h-screen flex items-center justify-center px-4">
		<div class="max-w-md w-full">
			<div class="card p-6 text-center">
				<div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
					<svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
					</svg>
				</div>
				<h2 class="text-2xl font-bold text-gray-900 mb-2 font-serif">Request Sent!</h2>
				<p class="text-gray-600 mb-4">Your access request has been sent. The pregnancy owner will be notified and can add you to their village.</p>
				<p class="text-sm text-gray-500">You'll receive an email if you're added to the village.</p>
			</div>
		</div>
	</div>

	<!-- Main Content -->
	<main id="timelineContent" class="hidden max-w-4xl mx-auto px-4 py-8">
		<!-- Timeline -->
		<div class="space-y-6" id="timelineContainer">
			<div class="text-center py-8">
				<div class="text-gray-500">Loading pregnancy updates...</div>
			</div>
		</div>

		<!-- Load More Button -->
		<div class="flex justify-center mt-8">
			<button id="loadMoreBtn" class="hidden px-6 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors">
				Load More
			</button>
		</div>
	</main>

	<script>
		let currentOffset = 0;
		const limit = 10;
		let hasMoreUpdates = true;
		let userEmail = null;
		let isSignedIn = false;

		// Get share ID from URL
		const pathParts = window.location.pathname.split('/');
		const shareId = pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2];

		// Check authentication and cached email on page load
		async function initializePage() {
			// Check if user is signed in
			const token = localStorage.getItem('jwt_token');
			if (token) {
				try {
					const response = await fetch('/api/profile', {
						headers: {
							'Authorization': 'Bearer ' + token
						}
					});
					
					if (response.ok) {
						const profile = await response.json();
						userEmail = profile.email;
						isSignedIn = true;
						console.log('User is signed in:', userEmail);
						// Skip email verification for signed-in users
						verifyEmailAccess(userEmail);
						return;
					}
				} catch (err) {
					console.log('Not signed in or token invalid');
				}
			}

			// Check for cached email
			const cachedEmail = localStorage.getItem('timeline_email');
			if (cachedEmail) {
				userEmail = cachedEmail;
				document.getElementById('emailInput').value = cachedEmail;
				console.log('Using cached email:', cachedEmail);
				// Automatically verify cached email
				verifyEmailAccess(cachedEmail);
				return;
			}

			// Show email verification form if no cached email or signed-in user
			console.log('Showing email verification form');
		}

		// Email verification form handler
		document.addEventListener('DOMContentLoaded', function() {
			document.getElementById('emailVerificationForm').addEventListener('submit', async (e) => {
				e.preventDefault();
				const email = document.getElementById('emailInput').value.trim();
				
				if (!email) {
					showVerificationError('Please enter your email address');
					return;
				}

				// Cache the email
				localStorage.setItem('timeline_email', email);
				userEmail = email;

				verifyEmailAccess(email);
			});

			document.getElementById('requestAccessForm').addEventListener('submit', async (e) => {
				e.preventDefault();
				const name = document.getElementById('requestName').value.trim();
				const relationship = document.getElementById('requestRelationship').value;
				const message = document.getElementById('requestMessage').value.trim();

				if (!name || !relationship) {
					showRequestError('Please fill in all required fields');
					return;
				}

				await submitAccessRequest(name, relationship, message);
			});

			// Initialize the page
			initializePage();
		});

		// Verify if email has access to the timeline
		async function verifyEmailAccess(email) {
			try {
				const response = await fetch(`/api/timeline/${shareId}/verify-access`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ email: email })
				});

				if (response.ok) {
					const result = await response.json();
					if (result.has_access) {
						// User has access, show timeline
						showTimeline();
					} else {
						// User needs to request access
						showRequestAccessForm();
					}
				} else if (response.status === 404) {
					showVerificationError('Pregnancy not found. Please check your link.');
				} else {
					showVerificationError('Unable to verify access. Please try again.');
				}
			} catch (err) {
				console.error('Error verifying access:', err);
				showVerificationError('Network error. Please try again.');
			}
		}

		// Submit access request
		async function submitAccessRequest(name, relationship, message) {
			try {
				const response = await fetch(`/api/timeline/${shareId}/request-access`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						email: userEmail,
						name: name,
						relationship: relationship,
						message: message
					})
				});

				if (response.ok) {
					showRequestSent();
				} else {
					const errorText = await response.text();
					showRequestError(errorText || 'Failed to submit request. Please try again.');
				}
			} catch (err) {
				console.error('Error submitting access request:', err);
				showRequestError('Network error. Please try again.');
			}
		}

		// UI state management
		function showTimeline() {
			document.getElementById('emailVerification').classList.add('hidden');
			document.getElementById('requestAccess').classList.add('hidden');
			document.getElementById('requestSent').classList.add('hidden');
			document.getElementById('pregnancyHeader').classList.remove('hidden');
			document.getElementById('timelineContent').classList.remove('hidden');
			loadTimeline();
		}

		function showRequestAccessForm() {
			document.getElementById('emailVerification').classList.add('hidden');
			document.getElementById('requestAccess').classList.remove('hidden');
			document.getElementById('requestSent').classList.add('hidden');
			document.getElementById('pregnancyHeader').classList.add('hidden');
			document.getElementById('timelineContent').classList.add('hidden');
		}

		function showRequestSent() {
			document.getElementById('emailVerification').classList.add('hidden');
			document.getElementById('requestAccess').classList.add('hidden');
			document.getElementById('requestSent').classList.remove('hidden');
			document.getElementById('pregnancyHeader').classList.add('hidden');
			document.getElementById('timelineContent').classList.add('hidden');
		}

		function goBackToEmailVerification() {
			// Clear cached email
			localStorage.removeItem('timeline_email');
			userEmail = null;
			document.getElementById('emailInput').value = '';
			
			document.getElementById('emailVerification').classList.remove('hidden');
			document.getElementById('requestAccess').classList.add('hidden');
			document.getElementById('requestSent').classList.add('hidden');
			document.getElementById('pregnancyHeader').classList.add('hidden');
			document.getElementById('timelineContent').classList.add('hidden');
		}

		function showVerificationError(message) {
			const errorDiv = document.getElementById('verificationError');
			errorDiv.textContent = message;
			errorDiv.classList.remove('hidden');
		}

		function showRequestError(message) {
			const errorDiv = document.getElementById('requestError');
			errorDiv.textContent = message;
			errorDiv.classList.remove('hidden');
		}

		// Load timeline on page load
		async function loadTimeline(append = false) {
			try {
				const response = await fetch(`/timeline/${shareId}?limit=${limit}&offset=${currentOffset}`);
				
				if (!response.ok) {
					if (response.status === 404) {
						showError('Pregnancy not found. Please check your link.');
						return;
					}
					showError('Failed to load timeline');
					return;
				}

				const data = await response.json();
				
				if (!append) {
					// Update page title and info
					updatePregnancyInfo(data.pregnancy);
				}
				
				displayUpdates(data.updates, append);
				
				// Update load more button
				if (data.updates.length < limit) {
					hasMoreUpdates = false;
					document.getElementById('loadMoreBtn').style.display = 'none';
				} else {
					currentOffset += limit;
					document.getElementById('loadMoreBtn').style.display = 'block';
				}
				
			} catch (err) {
				console.error('Error loading timeline:', err);
				showError('Network error loading timeline');
			}
		}

		function updatePregnancyInfo(pregnancy) {
			const title = `Follow ${pregnancy.parent_names}'s pregnancy!`;
			const description = `Follow ${pregnancy.parent_names}'s pregnancy. Currently at week ${pregnancy.current_week}, due ${formatDate(pregnancy.due_date)}`;
			
			// Update page content
			document.getElementById('pregnancyTitle').textContent = `${pregnancy.parent_names}'s Pregnancy`;
			document.getElementById('pregnancySubtitle').textContent = `Week ${pregnancy.current_week} â€¢ Due ${formatDate(pregnancy.due_date)}`;
			
			// Update page title and meta tags
			document.title = title;
			document.querySelector('meta[name="description"]').setAttribute('content', description);
			document.querySelector('meta[property="og:title"]').setAttribute('content', title);
			document.querySelector('meta[property="og:description"]').setAttribute('content', description);
			document.querySelector('meta[name="twitter:title"]').setAttribute('content', title);
			document.querySelector('meta[name="twitter:description"]').setAttribute('content', description);
		}

		function displayUpdates(updates, append = false) {
			const container = document.getElementById('timelineContainer');
			
			if (!append) {
				container.innerHTML = '';
			}

			if (updates.length === 0 && !append) {
				container.innerHTML = `
					<div class="text-center py-12">
						<div class="text-gray-500">No updates have been shared yet.</div>
						<div class="text-gray-400 text-sm mt-2">Check back soon for pregnancy updates!</div>
					</div>
				`;
				return;
			}

			updates.forEach(update => {
				const updateElement = createUpdateElement(update);
				container.appendChild(updateElement);
			});
		}

		function createUpdateElement(update) {
			const div = document.createElement('div');
			div.className = 'card';
			
			// Parse the ISO date string (server sends proper UTC ISO format)
			const updateDate = new Date(update.update_date);
			const timeAgo = getTimeAgo(updateDate);
			
			let mediaHtml = '';
			if (update.photos && update.photos.length > 0) {
				// Separate photos and videos
				const photos = update.photos.filter(item => {
					const ext = item.filename.toLowerCase().split('.').pop();
					return ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext);
				});
				const videos = update.photos.filter(item => {
					const ext = item.filename.toLowerCase().split('.').pop();
					return ['mp4', 'mov'].includes(ext);
				});

				const allMedia = [...photos, ...videos];
				
				mediaHtml = `
					<div class="mt-4">
						<div class="grid grid-cols-1 md:grid-cols-3 gap-3">
							${allMedia.slice(0, 6).map(media => {
								const ext = media.filename.toLowerCase().split('.').pop();
								const isVideo = ['mp4', 'mov'].includes(ext);
								
								if (isVideo) {
									const videoId = `video_${update.id}_${media.id || Math.random()}`;
									return `
										<div class="aspect-square bg-gray-100 rounded-lg overflow-hidden cursor-pointer relative" 
											 onclick="openVideoModal('/videos/${update.pregnancy_id}/${media.filename}', '${media.original_filename}')">
											<video id="${videoId}" class="w-full h-full object-cover" preload="metadata" muted
												   onloadeddata="generateVideoThumbnail('${videoId}')"
												   onerror="this.style.display='none'; this.nextElementSibling.innerHTML='<div class=\\'w-full h-full bg-gray-300 flex items-center justify-center text-gray-500\\'>ðŸŽ¥</div>'">
												<source src="/videos/${update.pregnancy_id}/${media.filename}#t=1" type="video/${ext === 'mov' ? 'quicktime' : 'mp4'}">
											</video>
											<div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-30 hover:bg-opacity-40 transition-colors">
												<div class="w-10 h-10 bg-white bg-opacity-90 rounded-full flex items-center justify-center">
													<svg class="w-5 h-5 text-gray-800" fill="currentColor" viewBox="0 0 20 20">
														<path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/>
													</svg>
												</div>
											</div>
										</div>
									`;
								} else {
									return `
										<div class="aspect-square bg-gray-100 rounded-lg overflow-hidden cursor-pointer" 
											 onclick="openPhotoModal('/images/${update.pregnancy_id}/${media.filename}', '${media.original_filename}')">
											<img src="/images/${update.pregnancy_id}/${media.filename}" 
												 alt="${media.original_filename}"
												 class="w-full h-full object-cover"
												 loading="lazy"
												 onerror="this.parentElement.innerHTML='<div class=\\'w-full h-full bg-gray-200 flex items-center justify-center\\'>ðŸ“·</div>'">
										</div>
									`;
								}
							}).join('')}
							${allMedia.length > 6 ? `
								<div class="aspect-square bg-gray-100 rounded-lg flex items-center justify-center text-gray-500">
									+${allMedia.length - 6} more
								</div>
							` : ''}
						</div>
					</div>
				`;
			}
			
			div.innerHTML = `
				<div class="p-6">
					<div class="flex items-start space-x-4">
						<div class="flex-shrink-0">
							<div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
								<span class="text-xl">ðŸ“¸</span>
							</div>
						</div>
						<div class="flex-1 min-w-0">
							<div class="md:flex md:items-center md:justify-between">
								<div class="flex-1">
									<h3 class="text-lg font-semibold text-gray-900">${update.title}</h3>
									<div class="mt-1 space-y-1 md:space-y-0">
										<div class="flex items-center space-x-2 text-sm text-gray-500 md:hidden">
											${update.week_number ? `<span class="bg-gray-100 px-2 py-1 rounded">Week ${update.week_number}</span>` : ''}
											<span>${timeAgo}</span>
										</div>
										<p class="text-sm text-gray-500">Posted by ${update.created_by.split(' ')[0]}</p>
									</div>
								</div>
								<div class="hidden md:flex items-center space-x-2 text-sm text-gray-500">
									${update.week_number ? `<span class="bg-gray-100 px-2 py-1 rounded">Week ${update.week_number}</span>` : ''}
									<span>${timeAgo}</span>
								</div>
							</div>
							${update.description ? `<p class="text-gray-700 mt-3">${update.description}</p>` : ''}
							${mediaHtml}
						</div>
					</div>
				</div>
			`;
			
			return div;
		}

		// Utility functions
		function formatDate(dateString) {
			// Parse YYYY-MM-DD as local date to avoid timezone conversion issues
			const parts = dateString.split('-');
			const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
			return date.toLocaleDateString('en-US', { 
				year: 'numeric', 
				month: 'long', 
				day: 'numeric' 
			});
		}

		function getTimeAgo(date) {
			const now = new Date();
			const diffTime = Math.abs(now - date);
			const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
			
			if (diffDays === 0) {
				const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
				if (diffHours === 0) {
					const diffMinutes = Math.floor(diffTime / (1000 * 60));
					return diffMinutes <= 1 ? 'Just now' : `${diffMinutes} minutes ago`;
				}
				return diffHours === 1 ? '1 hour ago' : `${diffHours} hours ago`;
			} else if (diffDays === 1) {
				return 'Yesterday';
			} else if (diffDays < 7) {
				return `${diffDays} days ago`;
			} else {
				// For older dates, show the actual date as posted (treating UTC as the parents' time)
				// Format as if the UTC time is the local time when they posted
				const year = date.getUTCFullYear();
				const month = date.getUTCMonth();
				const day = date.getUTCDate();
				const localDate = new Date(year, month, day);
				
				return localDate.toLocaleDateString(navigator.language || 'en-US', {
					year: 'numeric',
					month: 'short',
					day: 'numeric'
				});
			}
		}

		function showError(message) {
			const container = document.getElementById('timelineContainer');
			container.innerHTML = `
				<div class="text-center py-12">
					<div class="text-red-500">${message}</div>
				</div>
			`;
		}

		// Media modal functions
		function openPhotoModal(imageSrc, originalName) {
			const modal = document.getElementById('photoModal');
			const img = document.getElementById('photoModalImage');
			const caption = document.getElementById('photoModalCaption');
			
			img.src = imageSrc;
			caption.textContent = originalName || 'Photo';
			modal.classList.remove('hidden');
			document.body.style.overflow = 'hidden';
		}

		function openVideoModal(videoSrc, originalName) {
			const modal = document.getElementById('videoModal');
			const video = document.getElementById('videoModalVideo');
			const caption = document.getElementById('videoModalCaption');
			
			video.src = videoSrc;
			caption.textContent = originalName || 'Video';
			modal.classList.remove('hidden');
			document.body.style.overflow = 'hidden';
		}

		function closePhotoModal() {
			const modal = document.getElementById('photoModal');
			modal.classList.add('hidden');
			document.body.style.overflow = '';
		}

		function closeVideoModal() {
			const modal = document.getElementById('videoModal');
			const video = document.getElementById('videoModalVideo');
			video.pause();
			video.src = '';
			modal.classList.add('hidden');
			document.body.style.overflow = '';
		}

		function handlePhotoModalClick(event) {
			if (event.target.id === 'photoModal') {
				closePhotoModal();
			}
		}

		function handleVideoModalClick(event) {
			if (event.target.id === 'videoModal') {
				closeVideoModal();
			}
		}

		// Video thumbnail generation
		function generateVideoThumbnail(videoId) {
			const video = document.getElementById(videoId);
			if (!video) return;
			
			// Set the video to a specific time to get a good frame
			video.currentTime = 1; // 1 second in
			
			// The video should now show the frame at 1 second
			// The browser handles the thumbnail display automatically
		}

		// Load more button
		document.getElementById('loadMoreBtn').addEventListener('click', function() {
			if (hasMoreUpdates) {
				loadTimeline(true);
			}
		});

		// Load timeline on page load
		loadTimeline();
	</script>

	<!-- Photo Modal -->
	<div id="photoModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4" onclick="handlePhotoModalClick(event)">
		<div class="max-w-4xl max-h-full flex flex-col">
			<div class="flex justify-between items-center mb-4">
				<h3 id="photoModalCaption" class="text-white text-lg font-medium"></h3>
				<button onclick="closePhotoModal()" class="text-white hover:text-gray-300">
					<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
					</svg>
				</button>
			</div>
			<div class="flex-1 flex items-center justify-center">
				<img id="photoModalImage" class="max-w-full max-h-full object-contain rounded-lg" alt="Photo">
			</div>
		</div>
	</div>

	<!-- Video Modal -->
	<div id="videoModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4" onclick="handleVideoModalClick(event)">
		<div class="max-w-4xl max-h-full flex flex-col">
			<div class="flex justify-between items-center mb-4">
				<h3 id="videoModalCaption" class="text-white text-lg font-medium"></h3>
				<button onclick="closeVideoModal()" class="text-white hover:text-gray-300">
					<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
					</svg>
				</button>
			</div>
			<div class="flex-1 flex items-center justify-center">
				<video id="videoModalVideo" class="max-w-full max-h-full rounded-lg" controls>
					Your browser does not support the video tag.
				</video>
			</div>
		</div>
	</div>
</body>
</html>
